<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8" />
    <title>JH Labor Projection Manager</title>

    <!-- External Dependencies & CSS -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@1.24.1/build/global/luxon.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
            integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
          integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z"
          crossorigin="anonymous">

    <!-- JS Source Code Begins -->
    <script>
        window.addEventListener('load', () => {
            //Globals
            let DateTime = luxon.DateTime;
            let today = DateTime.local();
            let laborToken = "";
            let oppToken = "";
            let jobToken = "";
            let errorsToken = "";
            let tokenRuns = 0;
            let currRecKey = "";
            let inTestEnv = window.location.href.startsWith("http://localhost");
            let currWeeks = [];
            let currType = "";
            let recList = [];
            let oppRecsReturned = 0;
            let jobRecsReturned = 0;
            let dateUpdated = false;
            
            //===== Embed Jquery UI Calendar
            $(function () {
                $("#datepicker").datepicker();
            });

            //Init Bootstrap tooltips
            $(function () {
                $('[data-toggle="tooltip"]').tooltip()
            })

            //===== Handle Promise Errors
            function handleError(response, method) {
                if (!response.ok) {
                    let userResponse = "Issues obtaining required information from " + method + ". Contact Brandon Drake and provide this information";
                    let logResponse = response.status + ": " + response.statusText + "(" + method + ")";
                    let body = [{ "6": { "value": logResponse } }];

                    addRecords(body, errorsToken, errorDbid);

                    if (method != "AddRecord") { throw Error(userResponse); }
                }

                return response;
            }

            //===== Obtain all initial tokens GTG
            (async function getAllTokens() {
                let headers = {
                    'QB-Realm-Hostname': jhRealm,
                    'Content-Type': 'application/json'
                }

                let params = {
                    method: 'GET',
                    headers: headers,
                    credentials: 'include'
                }

                if (inTestEnv) {
                    getRecordList()
                } else {
                    try {
                        const getTokens = [
                            fetch('https://api.quickbase.com/v1/auth/temporary/' +  laborDbid, params), //Labor Table
                            fetch('https://api.quickbase.com/v1/auth/temporary/' + oppDbid, params), //Opportunity Table
                            fetch('https://api.quickbase.com/v1/auth/temporary/' + jobDbid, params),  //Jobs Table
                            fetch('https://api.quickbase.com/v1/auth/temporary/' + errorDbid, params)  //Errors Table
                        ];
                        let res = await Promise.all(getTokens);

                        await Promise.all(res.map(res => res.json()))
                            .then(keyArray => keyArray.map(key => key.temporaryAuthorization))
                            .then(keys => {
                                laborToken = keys[0];
                                oppToken = keys[1];
                                jobToken = keys[2];
                                errorsToken = keys[3];
                            });
                    } catch (e) {
                        tokenRuns < 5
                            ? getAllTokens()
                            : modalUpdate("999", "Error Obtaining tokens. Please contact Brandon Drake");
                    }
                }

                if (tokenRuns === 0 && !inTestEnv) {
                    getRecordList() //Run initial fetch of records, other wise just update keys
                } else if (tokenRuns < 12) {                    
                    tokenRuns++;
                    setTimeout(getAllTokens, 270000); //Continue to update tokens until user is idle for too long
                } else {
                    $("#resetBtn").addClass("hide");
                    $("#refreshPageBtn").removeClass("hide");
                    modalUpdate("999", "Idle for too Long. Please 'Refresh' or 'Exit' the page");
                }
            })();

            //Begin generating the record list
            function getRecordList() {
                oppRecsReturned = 0;
                jobRecsReturned = 0;
                recList = [];

                //Update UI
                $("#recSelector").addClass("hide");
                $("#recLoad").removeClass("hide");
                $("option[id]").remove();

                if (inTestEnv) {
                    recList = [
                        { "proxy": "2020-ST-167:415 - Sealy Mattress Manufacturing Co. LLC:Tempur-Sealy Office Renovation", "duration": 0, "type": "opp", "constStart": "2020-12-07", "status": "A" },
                        { "proxy": "2020-JH-134:American Timber & Steel:Building Addition", "duration": 0, "type": "opp", "constStart": "2020-09-28", "status": "B"},
                        { "proxy": "2020-JH-175:APIO, Inc.:Platform Extention", "duration": 0, "type": "opp", "constStart": "2020-11-02", "status": "O"},
                        { "proxy": "2019-294 - Kalahari Resorts", "duration": 2, "type": "job", "constStart": "2019-08-05"},
                        { "proxy": "2018-391 - Nagy Family Dental Group", "duration": 11, "type": "job", "constStart": "2020-05-04"}]
                    setTimeout(() => { buildRecSelector() }, 0);
                } else {
                    getOppList();
                }
            }

            //===== GET Opportunities GTG
            function getOppList() {
                let headers = {
                    'QB-Realm-Hostname': jhRealm,
                    'Authorization': 'QB-TEMP-TOKEN ' + oppToken,
                    'Content-Type': 'application/json'
                }

                let params = {
                    'method': 'POST',
                    'headers': headers
                };


                let reportID = $("input[name='searchType']:checked").attr("value") === 'user' ? 68 : 76;
                let oppURL = "https://api.quickbase.com/v1/reports/" + reportID + "/run?tableId=" + oppDbid +"&skip=";

                (function getOpps(url = oppURL, skip = 0) {
                    fetch(url + skip, params)
                        .then(response => handleError(response, "Record Selector"))
                        .then(response => response.json())
                        .then(data => {
                            let meta = {};
                            oppRecsReturned += data.metadata['numRecords'];
                            meta = { "totRecs": data.metadata['totalRecords'], "recsReturned": oppRecsReturned };
                            for (rec in data.data) {
                                let proxyID = 253;
                                let durationID = 235;
                                let constStart = 255;
                                let status = data.data[rec][14].value.split("-")[0];
                                let obj = {}
                                obj = { "proxy": data.data[rec][proxyID].value, "duration": data.data[rec][durationID].value, "type": "opp", "constStart": data.data[rec][constStart].value, "status": status };
                                recList.push(obj);
                            }
                            return meta;
                        }).then(meta => {
                            meta.totRecs === meta.recsReturned
                                ? getJobList()
                                : getOpps(oppURL, meta.recsReturned)
                        }).catch(err => { modalUpdate("999", err) });
                })();
            }

            function getJobList() {
                let headers = {
                    'QB-Realm-Hostname': jhRealm,
                    'Authorization': 'QB-TEMP-TOKEN ' + jobToken,
                    'Content-Type': 'application/json'
                }

                let params = {
                    'method': 'POST',
                    'headers': headers
                };

                let reportID = $("input[name='searchType']:checked").attr("value") === 'user' ? 108 : 109;
                let jobURL = "https://api.quickbase.com/v1/reports/" + reportID + "/run?tableId=" + jobDbid + "&skip=";

                (function getJobs(url = jobURL, skip = 0) {
                    fetch(url + skip, params)
                        .then(response => handleError(response, "Record Selector"))
                        .then(response => response.json())
                        .then(data => {
                            let meta = {};
                            jobRecsReturned += data.metadata['numRecords'];
                            meta = { "totRecs": data.metadata['totalRecords'], "recsReturned": jobRecsReturned };
                            for (rec in data.data) {
                                let proxyID = 185;
                                let durationID = 512;
                                let constStart = 514;
                                let obj = {}
                                obj = { "proxy": data.data[rec][proxyID].value, "duration": data.data[rec][durationID].value, "type": "job", "constStart": data.data[rec][constStart].value };
                                recList.push(obj);
                            }
                            return meta;
                        })
                        .then(meta => {
                            meta.totRecs === meta.recsReturned
                                ? buildRecSelector(recList)
                                : getJobs(jobURL, meta.recsReturned)
                        })
                        .catch(err => { modalUpdate("999", err) });
                })();
            }

            //===== Build Record Selector Dropdown GTG
            function buildRecSelector() {
                let oppGroup = $("#oppList");
                let jobGroup = $("#jobList");
                let oppOptions = [];
                let jobOptions = [];
                let type = "";

                //Build List
                for (let i = 0; i < recList.length; i++) {
                    type = recList[i].type;
                    let isOpp = type === "opp";

                    let listEL = document.createElement("option");
                    listEL.setAttribute("type", recList[i].type);
                    listEL.setAttribute("data-constStart", recList[i].constStart);
                    listEL.id = isOpp
                        ? recList[i].proxy.split(":")[0]
                        : recList[i].proxy.split(" - ")[0];
                    listEL.innerHTML = (isOpp
                        ? recList[i].proxy.split(":")[1] + " - " + recList[i].proxy.split(":")[0]
                        : recList[i].proxy) + "(" + recList[i].duration + ")";
                    

                    if (recList[i].duration === 0) { listEL.setAttribute("class", "warning") };

                    if (listEL.id === currRecKey) { listEL.selected = "selected" };

                    if (isOpp) {
                        listEL.title = recList[i].proxy.split(":")[2];
                        listEL.setAttribute("data-status", recList[i].status.toLowerCase())
                        oppOptions.push(listEL)
                    } else {
                        jobOptions.push(listEL);
                    }
                }
                oppGroup.append(oppOptions);
                jobGroup.append(jobOptions);

                //Update UI
                recList.length ? $("#noRecords").addClass("hide") : $("#noRecords").removeClass("hide");
                $("#recLoad").addClass("hide");
                $("#recSelector").removeClass("hide");
                currRecKey ? fetchData() : $("#noRecords").removeClass("hide");
            }

            //===== GET Opportunity Manpower weeks and totals GTG
            function fetchData() {
                let recordKey = $("#oppID option:selected").attr("id");
                let type = $("#oppID option:selected").attr("type");
                let constStart = $("#oppID option:selected").attr("data-constStart");
                currRecKey = recordKey;
                currType = type;
                tokenRuns = 0; //User interaction, reset token runs to ensure they can keep working

                $("#labor").addClass("hide"); // HIde UI to prvent accidental changes

                // Lookup record
                let keyID = type === "opp" ? "7" : "23";
                let query = "{" + keyID + ".EX." + recordKey + "}AND({12.GTE." + today + "}OR{12.IR.'this wk'})";
                let headers = {
                    'QB-Realm-Hostname': jhRealm,
                    'Authorization': 'QB-TEMP-TOKEN ' + laborToken,
                    'Content-Type': 'application/json'
                }

                let body = {
                    "from": laborDbid,
                    "select": [
                        3,
                        6,
                        7,
                        12,
                        36
                    ],
                    "where": query
                }

                let params = { method: 'POST', headers: headers, "body": JSON.stringify(body) };

                let URL = 'https://api.quickbase.com/v1/records/query';

                inTestEnv
                    ? buildImport({
                        "data": [
                            {
                                "3": {
                                    "value": 149
                                },
                                "6": {
                                    "value": 4
                                },
                                "7": {
                                    "value": "2020-JH-113"
                                },
                                "12": {
                                    "value": "2020-10-26"
                                },
                                "36": {
                                    "value": "vacation drywall"
                                }
                            },
                            {
                                "3": {
                                    "value": 150
                                },
                                "6": {
                                    "value": 4
                                },
                                "7": {
                                    "value": "2020-JH-113"
                                },
                                "12": {
                                    "value": "2020-11-02"
                                },
                                "36": {
                                    "value": "concrete"
                                }
                            },
                            {
                                "3": {
                                    "value": 151
                                },
                                "6": {
                                    "value": 4
                                },
                                "7": {
                                    "value": "2020-JH-113"
                                },
                                "12": {
                                    "value": "2020-11-09"
                                },
                                "36": {
                                    "value": "masonry"
                                }
                            },
                            {
                                "3": {
                                    "value": 152
                                },
                                "6": {
                                    "value": 5
                                },
                                "7": {
                                    "value": "2020-JH-113"
                                },
                                "12": {
                                    "value": "2020-11-16"
                                },
                                "36": {
                                    "value": "vacation"
                                }
                            },
                            {
                                "3": {
                                    "value": 153
                                },
                                "6": {
                                    "value": 5
                                },
                                "7": {
                                    "value": "2020-JH-113"
                                },
                                "12": {
                                    "value": "2020-11-23"
                                },
                                "36": {
                                    "value": ""
                                }
                            },
                            {
                                "3": {
                                    "value": 154
                                },
                                "6": {
                                    "value": 5
                                },
                                "7": {
                                    "value": "2020-JH-113"
                                },
                                "12": {
                                    "value": "2020-11-30"
                                },
                                "36": {
                                    "value": ""
                                }
                            },
                            {
                                "3": {
                                    "value": 155
                                },
                                "6": {
                                    "value": 5
                                },
                                "7": {
                                    "value": "2020-JH-113"
                                },
                                "12": {
                                    "value": "2020-12-07"
                                },
                                "36": {
                                    "value": "drywall"
                                }
                            }
                        ],
                        "fields": [
                            {
                                "id": 3,
                                "label": "Record ID#",
                                "type": "recordid"
                            },
                            {
                                "id": 6,
                                "label": "Manpower",
                                "type": "numeric"
                            },
                            {
                                "id": 7,
                                "label": "Related Opportunity",
                                "type": "text"
                            },
                            {
                                "id": 12,
                                "label": "Related Weekday",
                                "type": "date"
                            },
                            {
                                "id": 36,
                                "label": "specialtyList",
                                "type": "text"
                            }
                        ],
                        "metadata": {
                            "numFields": 5,
                            "numRecords": 7,
                            "skip": 0,
                            "totalRecords": 7
                        }
                    })
                    : fetch(URL, params)
                        .then(response => handleError(response, "fetchData"))
                        .then(response => response.json())
                        .then(data => buildImport(data, constStart))
                        .catch(err => { modalUpdate("999", err) });
            }

            /**
             * Builds the objects for each week returned from fetch GTG
             *
             * @param response json from fetch
             * @param constStart QB start date for the record
             */
            function buildImport(response, constStart) {
                currWeeks = [];
                let existingWeeks = [];
                let data = response.data;

                if (data.length > 0) {

                    let startDate = data[0][12].value;
                    let endDate = data[data.length - 1][12].value;

                    for (let i = 0; i < data.length; i++) {
                        let existingWeek = {};
                        let dateBegin = data[i][12].value;
                        let mpwr = data[i][6].value;
                        let recID = data[i][3].value;
                        let specialtyList = data[i][36].value;

                        existingWeek = { "date": dateBegin, "mpwr": mpwr, "recID": recID, "specialty": specialtyList };
                        existingWeeks.push(existingWeek);
                    }

                    currWeeks = existingWeeks;
                    if ($(".week").length) { clearWeeks() };
                    genWeeksBegin(startDate, endDate, existingWeeks);
                } else {
                    clearWeeks();
                    constStart >= today.toISODate() ? $("#date_beginning").val(constStart) : "";
                }
            }

            /**
             *  Generate the weeks and manpower GTG
             *
             * @param sd optional start date of job or opp
             * @param ed optional end date of job or opp
             */
            function genWeeksBegin(sd = null, ed = null) {
                //Select and Format Begin/End Dates
                let startDate = !sd ? DateTime.fromISO($("#date_beginning").val()) : DateTime.fromISO(sd);
                let endDate = !ed ? DateTime.fromISO($("#date_ending").val()) : DateTime.fromISO(ed);
                let weekCounter = 0;
                let weekList = [];

                $("#date_beginning").val(startDate.toISODate());
                $("#date_ending").val(endDate.toISODate());

                //Check for if rec contains specialty crew dates
                let hasSpecialty = function (spec, specList, start) {
                    if (specList.includes(spec.value) && start.toISODate() === currWeeks[weekCounter].date) { spec.setAttribute("checked", true) };
                }

                if (checkDates(startDate, endDate)) {
                    $("#noRecords").addClass("hide");
                    while (startDate <= endDate) {
                        let dateDisplay = document.createElement("label");
                        let manpwrInput = document.createElement("input");
                        let specialty = document.createElement("div");
                        let highMpwr = document.createElement("span");
                        let weekDiv = document.createElement("div");
                        let specList = weekCounter < currWeeks.length ? currWeeks[weekCounter].specialty : "";


                        (function buildDate() {
                            //Date Attributes
                            dateDisplay.id = "D" + weekCounter;
                            dateDisplay.innerHTML = startDate.toLocaleString();
                            dateDisplay.setAttribute("class", "dateLabel");
                            dateDisplay.setAttribute("name", startDate.toISODate());
                            dateDisplay.setAttribute("for", "M" + weekCounter);
                            currWeeks.length && weekCounter < currWeeks.length ? dateDisplay.setAttribute("data-recID", currWeeks[weekCounter].recID) : "";
                        })();

                        (function buildMpwr() {
                            //Manpower Element Attributes
                            manpwrInput.setAttribute("class", "form-control mpwrInput");
                            manpwrInput.type = "number";
                            manpwrInput.id = "M" + weekCounter;
                            manpwrInput.setAttribute("data-date", startDate.toLocaleString());
                            manpwrInput.addEventListener("change", checkEntry);
                            manpwrInput.addEventListener("focus", updateCalendar)
                            highMpwr.className = "highMpwr hide warning";
                        })();

                        (function buildVaca() {
                            //Specialty Selectors
                            specialty.setAttribute("class", "specialtyselector content-center");
                            let vacation = document.createElement("input");
                            vacation.setAttribute("type", "checkbox");
                            vacation.id = "vaca" + weekCounter;
                            vacation.setAttribute("value", "vacation");
                            vacation.setAttribute("class", "specialty");
                            vacation.setAttribute("tabindex", "-1");
                            vacation.setAttribute("data-toggle", "tooltip");
                            vacation.setAttribute("data-placement", "top");
                            vacation.setAttribute("title", "Vacation");
                            hasSpecialty(vacation, specList, startDate);
                            let vlabel = document.createElement("label");
                            vlabel.setAttribute("for", "vaca" + weekCounter);
                            vlabel.setAttribute("class", "speclabel");
                            vlabel.innerHTML = "V |";
                            specialty.appendChild(vacation);
                            specialty.appendChild(vlabel);
                        })();

                        (function buildConcrete() {
                            let concrete = document.createElement("input");
                            concrete.setAttribute("type", "checkbox");
                            concrete.id = "concrete" + weekCounter;
                            concrete.setAttribute("value", "concrete");
                            concrete.setAttribute("class", "specialty");
                            concrete.setAttribute("tabindex", "-1");
                            hasSpecialty(concrete, specList, startDate);
                            concrete.setAttribute("data-toggle", "tooltip");
                            concrete.setAttribute("data-placement", "top");
                            concrete.setAttribute("title", "Concrete");
                            let clabel = document.createElement("label");
                            clabel.setAttribute("for", "concrete" + weekCounter);
                            clabel.setAttribute("class", "speclabel");
                            clabel.innerHTML = "C |";
                            specialty.appendChild(concrete);
                            specialty.appendChild(clabel);
                        })();

                        (function buildMasonry() {
                            let masonry = document.createElement("input");
                            masonry.setAttribute("type", "checkbox");
                            masonry.id = "masonry" + weekCounter;
                            masonry.setAttribute("value", "masonry");
                            masonry.setAttribute("class", "specialty");
                            masonry.setAttribute("tabindex", "-1");
                            masonry.setAttribute("data-toggle", "tooltip");
                            masonry.setAttribute("data-placement", "top");
                            masonry.setAttribute("title", "Masonry");
                            hasSpecialty(masonry, specList, startDate);
                            let mlabel = document.createElement("label");
                            mlabel.setAttribute("for", "masonry" + weekCounter);
                            mlabel.setAttribute("class", "speclabel");
                            mlabel.innerHTML = "M |";
                            specialty.appendChild(masonry);
                            specialty.appendChild(mlabel);
                        })();

                        (function buildDrywall() {
                            let drywall = document.createElement("input");
                            drywall.setAttribute("type", "checkbox");
                            drywall.id = "drywall" + weekCounter;
                            drywall.setAttribute("value", "drywall");
                            drywall.setAttribute("class", "specialty");
                            drywall.setAttribute("tabindex", "-1");
                            drywall.setAttribute("data-toggle", "tooltip");
                            drywall.setAttribute("data-placement", "top");
                            drywall.setAttribute("title", "Drywall");
                            hasSpecialty(drywall, specList, startDate);
                            let dlabel = document.createElement("label");
                            dlabel.setAttribute("for", "drywall" + weekCounter);
                            dlabel.setAttribute("class", "speclabel");
                            dlabel.innerHTML = "D";
                            specialty.appendChild(drywall);
                            specialty.appendChild(dlabel);
                        })();

                        (function buildWeek() {
                            weekDiv.setAttribute("class", "week");
                            weekDiv.id = "W" + weekCounter;
                            weekDiv.appendChild(dateDisplay);
                            weekDiv.appendChild(manpwrInput);
                            if (currType === "job") { weekDiv.appendChild(specialty) };
                            weekDiv.appendChild(highMpwr);
                        })();

                        //Generate Data array
                        weekList.push(weekDiv);
                        //Increment values
                        startDate = startDate.plus({ days: 7 });
                        weekCounter++;
                    }
                    $("#weeks").prepend(weekList);

                    //Auto set manpower fields if split checkbox is checked
                    $("#evenSplit").is(":checked")
                        ? setEqualMpwr(weekCounter)
                        : popManpower();

                    //Display Results
                    $("#labor").removeClass("hide");
                    $("#finishBtn").removeClass("hide");

                    //Update UI
                    $(".week").even().addClass("even");
                    weekCounter < currWeeks.length ? $("#deleteWarning").removeClass("hide") : $("#deleteWarning").addClass("hide");

                    //Get new totals (if any)
                    getMpwrTotal();
                };
            }

            //===== Repopulates the Manpower after duration update to just fill weeks from beginnning
            function popManpower() {
                let newDuration = $(".week").length;

                if (newDuration === currWeeks.length) {
                    $(".week").each(function (index) {
                        let mpwr = $(this).find(".mpwrInput");
                        mpwr.val(currWeeks[index].mpwr);
                    });
                } else {
                    for (let i = 0; i < currWeeks.length; i++) {
                        $(".week").each(function () {
                            let mpwr = $(this).find(".mpwrInput");
                            let date = $(this).find("label").attr("name");

                            if (currWeeks[i].date === date) {
                                mpwr.val(currWeeks[i].mpwr);
                            }
                        })
                    }
                }
            }

            /**
             * Check the start and end dates
             *
             * @param startDate Start date passed in by user
             * @param endDate End Date passed in by user (or by duration)
             *
             * @returns boolean Returns true if date tests match
             */
            function checkDates(startDate, endDate) {
                let startWeek = startDate.toFormat("WW");
                let currWeek = today.toFormat("WW");
                let invalidStart = startDate < today && startWeek != currWeek;
                let invalidEnd = startDate > endDate;

                // Start check
                if (invalidStart) {
                    $("#start span.invalidStart").length ? "" : $("#start label").append("<span class=invalidStart></span>");
                } else {
                    $("#start span.invalidStart").remove()
                }

                // End check
                if (invalidEnd) {
                    $("#end span.invalidEnd").length ? "" : $("#end label").append("<span class=invalidEnd></span>");
                } else { $("#end span.invalidEnd").remove() }

                return (invalidStart || invalidEnd)
                    ? false //Dates not correct
                    : true //All dates valid to proceed
            }

            //===== Updates Calendar to follow the selected manpower week begin
            function updateCalendar() {
                let date = $(this).attr("data-date");

                $("#datepicker").datepicker("setDate", date);
            }

            /**
             * calc, split, set manpower evenly as possible GTG
             *
             * @param totalWeeks total number of weeks for the record
             */
            function setEqualMpwr(totalWeeks) {
                let totalMpwr = Math.abs(Math.round($("#totalMpwr").val()));
                let weeklyMpwr = Math.floor(totalMpwr / totalWeeks);
                let remainder = totalMpwr % totalWeeks;

                if (totalMpwr >= totalWeeks) {
                    for (let i = 0; i < totalWeeks; i++) {
                        let week = $("#M" + i);
                        //week.attr("readonly", true);
                        //distribute remainder to keep manpower relatively equal
                        if (remainder > 0) {
                            week.val(weeklyMpwr + 1);
                            remainder--;
                        } else { week.val(weeklyMpwr); }
                    }
                    $("#evenSplit").prop("checked", false);
                } else {
                    $("#noSplit").removeClass("hide");
                    setTimeout(function () { $("#noSplit").addClass("hide"); }, 5000);
                    $("#evenSplit").prop("checked", false);
                }
            }

            //===== Generates the body of API Call GTG
            function genUpsert() {
                let records = [];
                let relatedRecField = currType === "opp" ? "7" : "23";

                $(".week").each(function (index) {
                    let date = $("#D" + index).attr("name");
                    let mpwr = Math.round($("#M" + index).val());
                    let record = {};
                    let existingId = $("#D" + index).attr("data-recid");

                    if (existingId) { record["3"] = { value: existingId } };
                    record["12"] = { value: date };
                    record["6"] = { value: mpwr };
                    record[relatedRecField] = { value: currRecKey };

                    if (currType === "job") {
                        $("#W" + index + " .specialty").each(function () {
                            let specType = $(this).val();
                            if ($(this).prop("checked")) {
                                switch (specType) {
                                    case "vacation":
                                        record["32"] = { "value": true };
                                        break;
                                    case "concrete":
                                        record["33"] = { "value": true };
                                        break;
                                    case "masonry":
                                        record["34"] = { "value": true };
                                        break;
                                    case "drywall":
                                        record["35"] = { "value": true };
                                        break;
                                    default:
                                        break;
                                };
                            } else {
                                switch (specType) {
                                    case "vacation":
                                        record["32"] = { "value": false };
                                        break;
                                    case "concrete":
                                        record["33"] = { "value": false };
                                        break;
                                    case "masonry":
                                        record["34"] = { "value": false };
                                        break;
                                    case "drywall":
                                        record["35"] = { "value": false };
                                        break;
                                    default:
                                        break;
                                };
                            };
                        });
                    };

                    records.push(record);
                })

                if (!getMpwrTotal()) {
                    $("#mpwrMismatch").removeClass("hide");
                } else if (compareUpload()) {
                    alert("No Changes Made. Nothing was uploaded");
                } else { addRecords(records, laborToken, laborDbid) };
            }

            /**
             *  Quick Base API to add records
             *
             * @param records Json build for body of POST
             * @param dbid the dbid to which the records will be added
             */
            function addRecords(records, token, dbid) {
                let headers = {
                    'QB-Realm-Hostname': jhRealm,
                    'Authorization': 'QB-TEMP-TOKEN ' + token,
                    'Content-Type': 'application/json'
                }

                let body = {
                    "to": dbid, "data":
                        records
                };

                if (inTestEnv) {
                    console.log(JSON.stringify(body)) //modalUpdate("999", "Success")
                } else {
                    const xmlHttp = new XMLHttpRequest();
                    xmlHttp.open('POST', 'https://api.quickbase.com/v1/records', true);
                    for (const key in headers) {
                        xmlHttp.setRequestHeader(key, headers[key]);
                    }
                    xmlHttp.onreadystatechange = function () {
                        if (xmlHttp.readyState === XMLHttpRequest.DONE) {
                            let status = xmlHttp.status;
                            if (status === 0 || (status >= 200 && status < 400)) {
                                dbid != errorDbid
                                    ? $(".week").length < currWeeks.length
                                        ? deleteRecords()
                                        : modalUpdate(status, "Upload") //Update status to user
                                    : console.log("error logged")
                            } else {
                                handleError(xmlHttp, "AddRecords");
                                modalUpdate(status, xmlHttp.responseText);
                            }
                        }
                    };

                    xmlHttp.send(JSON.stringify(body))
                }

            }

            //===== Delete Records GTG
            function deleteRecords() {
                let currWeeksLength = currWeeks.length;
                let numRecToDelete = currWeeksLength - $(".week").length;
                let where = "";

                for (let i = 1; i <= numRecToDelete; i++) {
                    let recID = currWeeks[currWeeksLength - i].recID;
                    let template = "{3.EX." + recID + "}";
                    let or = "OR";

                    i != numRecToDelete
                        ? where += template + or
                        : where += template
                }

                let headers = {
                    'QB-Realm-Hostname': jhRealm,
                    'Authorization': 'QB-TEMP-TOKEN ' + laborToken,
                    'Content-Type': 'application/json'
                }
                let body = {
                    "from": laborDbid,
                    "where": where
                }

                inTestEnv ? console.log(JSON.stringify(body)) :
                    fetch('https://api.quickbase.com/v1/records',
                        {
                            method: 'DELETE',
                            headers: headers,
                            body: JSON.stringify(body)
                        })
                        .then(response => handleError(response, "deleteRecords"))
                        .then(res => {
                            return res.json().then(res => console.log(res)).then(modalUpdate("200", "Delete", numRecToDelete))
                        })
                        .then()
                        .catch(err => { modalUpdate("999", err) });
            }

            //===== Check Mpwr Entry for large values GTG
            function checkEntry() {
                let value = this.value;
                let id = this.id;
                parseInt(value) < 30
                    ? $("#" + id).siblings(".highMpwr").addClass("hide")
                    : $("#" + id).siblings(".highMpwr").removeClass("hide").val("Seems High");

                getMpwrTotal();
            }

            /*===== Total Manpower GTG
                Return: Bool
            */
            function getMpwrTotal() {
                let mpwrNeeded = Math.abs(Math.round($("#totalMpwr").val()));
                let totalMpwr = 0;
                let mpwrRemain = 0;
                let mpwrJQ = $("#hours");
                let remainJQ = $("#hoursRemaining");


                $(".week").each(function (index) {
                    let mpwr = Math.round($("#M" + index).val());
                    totalMpwr += mpwr;
                });


                //Set New Values
                mpwrRemain = mpwrNeeded > 0 ? totalMpwr - mpwrNeeded : 0;
                mpwrJQ.text(totalMpwr);
                if (mpwrNeeded > 0) {
                    mpwrRemain === 0
                        ? remainJQ.removeClass("mpwrMismatch").addClass("eqMpwr").text(mpwrRemain)
                        : mpwrRemain < 0
                            ? remainJQ.removeClass("eqMpwr").addClass("mpwrMismatch").text(Math.abs(mpwrRemain) + " Remain")
                            : remainJQ.removeClass("eqMpwr").addClass("mpwrMismatch").text(mpwrRemain + " Over")
                };

                //UI Clean-up
                if (!$("#mpwrMismatch").hasClass("hide")) { $("#mpwrMismatch").addClass("hide") };

                return mpwrRemain === 0 || mpwrNeeded <= 0;
            }

            /**Compare the uploads to make sure they are not the same GTG
             * 
             * @returns Boolean to determine if the labor needs have changed to trigger the upload
             */
            function compareUpload() {
                let weeksToUpload = [];

                $(".week").each(function (index) {
                    let week = {};
                    let date = $(this).find("label").attr("name");
                    let mpwr = parseInt($(this).find("input").val());
                    let recid = parseInt($(this).find("label").attr("data-recid"));
                    let specList = "";

                    $("#W" + index + " .specialty").each(function () {
                        $(this).prop("checked")
                            ? specList += $(this).val() + " "
                            : ""
                    });

                    week = { "date": date, "mpwr": mpwr, "recID": recid, "specialty": specList.trim() };
                    weeksToUpload.push(week);
                });

                return JSON.stringify(weeksToUpload) === JSON.stringify(currWeeks);
            }

            //===== Updates Labor Weeks with new data GTG
            function updateWeeks() {
                let updatedStart = DateTime.fromISO($("#date_beginning").val());
                let updatedEnd = DateTime.fromISO($("#date_ending").val());
                let startDay = updatedStart.toFormat("c");
                let endDay = updatedEnd.toFormat("c");

                //Adjust start to beginning of week
                switch (startDay) {
                    case "1": //Monday
                        updatedStart = updatedStart;
                        break;
                    case "2":
                        updatedStart = updatedStart.minus({ days: 1 });
                        break;
                    case "3":
                        updatedStart = updatedStart.minus({ days: 2 });
                        break;
                    case "4":
                        updatedStart = updatedStart.minus({ days: 3 });
                        break;
                    case "5":
                        updatedStart = updatedStart.minus({ days: 4 });
                        break;
                    case "6":
                        updatedStart = updatedStart.minus({ days: 5 });
                        break;
                    case "7": //Sunday
                        updatedStart = updatedStart.plus({ days: 1 });
                        break;
                    default:
                        console.log("Error With conversion");
                };

                //Adjust start to beginning of week
                switch (endDay) {
                    case "1": //Monday
                        updatedEnd = updatedEnd;
                        break;
                    case "2":
                        updatedEnd = updatedEnd.minus({ days: 1 });
                        break;
                    case "3":
                        updatedEnd = updatedEnd.minus({ days: 2 });
                        break;
                    case "4":
                        updatedEnd = updatedEnd.minus({ days: 3 });
                        break;
                    case "5":
                        updatedEnd = updatedEnd.minus({ days: 4 });
                        break;
                    case "6":
                        updatedEnd = updatedEnd.minus({ days: 5 });
                        break;
                    case "7": //Sunday
                        updatedEnd = updatedEnd.plus({ days: 1 });
                        break;
                    default:
                        console.log("Error With conversion");
                }

                $("#date_beginning").val(updatedStart.toISODate());
                $("#date_ending").val(updatedEnd.toISODate());

                if (checkDates(updatedStart, updatedEnd)) {
                    $(".week").remove();
                    $("#update").addClass("hide");
                    genWeeksBegin();
                    getMpwrTotal();
                }
            }

            //===== Display Update Weeks Button if any field changes GTG
            function showUpdate() {
                let startMatch = currWeeks.length ? $("#date_beginning").val() === currWeeks[0].date : false;
                let endMatch = currWeeks.length ? $("#date_ending").val() === currWeeks[currWeeks.length - 1].date : false;

                dateUpdated = !startMatch || !endMatch;

                if (dateUpdated) {
                    $("#update").removeClass("hide");
                    $("#finishBtn").addClass("hide");
                } else if ($("#evenSplit").is(':checked')) {
                    $("#update").removeClass("hide");
                    $("#finishBtn").addClass("hide");
                } else {
                    $("#update").addClass("hide");
                    $("#finishBtn").removeClass("hide");
                }
            }

            //===== Set the end date when duration is used
            function setEndByDuration() {
                let duration = $("#duration_weeks").val();
                let startDate = DateTime.fromISO($("#date_beginning").val());
                let endDate = startDate.plus({ weeks: duration - 1 }).toISODate();

                if (startDate.isValid && duration) {
                    $("#date_ending").val(endDate);
                }
            }

            //===== Change UI for setting job duration
            function changeWkEndType() {
                let startDate = DateTime.fromISO($("#date_beginning").val());
                let endDate = DateTime.fromISO($("#date_ending").val());
                let dateDuration = endDate.diff(startDate, 'weeks').toObject().weeks + 1;
                let setByDuration = $("#wkendbyduration");
                let setByDate = $("#wkendbydate");
                let numWeeks = $(".week").length;
                let type = this.value;

                if (type === "byDuration") {
                    (dateDuration) != numWeeks ? $("#duration_weeks").val(dateDuration) : $("#duration_weeks").val(numWeeks);
                    setByDuration.removeClass("hide");
                    setByDate.addClass("hide");
                } else {
                    setByDuration.addClass("hide");
                    setByDate.removeClass("hide");
                }
            }

            //===== Clear manpower totals
            function clearMpwr() {
                $(".week .mpwrInput").val("");
                getMpwrTotal();
            }

            //===== Clear All Data GTG
            function clearWeeks() {
                $(".week").remove();
                $("#date_beginning, #date_ending, #totalMpwr").val("");
                $("#evenSplit").prop("checked", false);
                $("#finishBtn").addClass("hide");
                $("#start p.invalidStart, span.invalidEnd, span.invalidDay").remove();
                $("#end p.invalidStart, span.invalidEnd, span.invalidDay").remove();
                $("#hoursRemaining, #hours").text("");
            }

            //===== Reset weeks GTG
            function resetWeeks() {
                $("#update").addClass("hide");
                fetchData()
            }

            /** Updates the Modal Window to inform User of status
             * 
             * @param status Return Status of the http request
             * @param requestMessage Mesage to be displayed based on the response status
             * @param toDelete Passes in num of records to be deleted
             */
            function modalUpdate(status, requestMessage = "", toDelete = 0) {
                let message = $("#modal-message");
                let title = $("#modalTitle");
                title.text("");
                message.text("");

                $("#loadScreen").modal("toggle");

                if (typeof failCounter == 'undefined') {
                    failCounter = 0;
                }
                if (status >= 200 && status < 400) {
                    let messageText = requestMessage === "Upload" ? "Uploading..." : "Uploading & Deleting " + toDelete + " week/s..."
                    title.text("Updating Labor Projections");
                    message.text(messageText);
                    setTimeout(function () {
                        message.text("Update Sucessful.");
                        getRecordList();
                        setTimeout(function () { $("#loadScreen").modal("toggle"); }, 2000)
                    }, 1000);
                } else if (status === "401") {
                    title.text("Error");
                    message.text("Authorization Issue. Refreshing page to try again in 3 seconds");
                    setTimeout(function () {
                        message.text("Authorization Issue. Refreshing page to try again in 3 seconds");
                        $("#loadScreen").modal("toggle");
                        window.location.reload();
                    }, 3000);
                } else if (status === "999") {
                    title.text("Error")
                    message.text(requestMessage);
                    $("#exitModal").removeClass("hide");
                    $("#refreshPageBtn").removeClass("hide");
                } else if (failCounter === 0) {
                    title.text("Unsuccessful Upload")
                    message.text("Upload Failed. Lets try one more time. Close and try to 'Upload Schedule' Again");
                    $("#closeModal").removeClass("hide");
                    failCounter++;
                } else {
                    title.text("Upload Failed");
                    message.text(requestMessage + "\nPlease take a screen shot or contact Brandon Drake \n(ext. 266)");
                    message.addClass("spaced");
                    $("#closeModal").removeClass("hide");
                    $("#exitModal").removeClass("hide");
                }
            }

            //===== Filter record results
            function filterByType() {
                jobList = $("#jobList");
                oppList = $("#oppList");
                let type = this.value;

                switch (type) {
                    case "opps":
                        oppList.removeClass("hide");
                        jobList.addClass("hide");
                        $("#oppStatus").removeClass("hide");
                        break;
                    case "jobs":
                        oppList.addClass("hide");
                        jobList.removeClass("hide");
                        $("#oppStatus").addClass("hide");
                        break;
                    case "both":
                        oppList.removeClass("hide");
                        jobList.removeClass("hide");
                        $("#oppStatus").removeClass("hide");
                        break;
                    default:
                }
            }

            //===== Filter Opps by type
            function filterByOppStatus() {
                let selection = this.value;
                let options = $("#oppList option");

                console.log(selection);

                if (selection === "all") {
                    options.removeClass("hide");
                } else {
                    options.each(function () {
                        let status = $(this).attr("data-status");

                        status === selection
                            ? $(this).removeClass("hide")
                            : $(this).addClass("hide");
                    });
                }
            }

            //===== Hide Modal Buttons
            function hideModalButtons() {
                $("#closeModal").addClass("hide");
                $("#exitModal").addClass("hide");
                $("#refreshPageBtn").addClass("hide");
            }

            //===== Navigate to opportunity in quickbase
            function goToQuickBase() {
                let homeUrl = "https://" + jhRealm + "/db/" + oppDbid;
                let oppUrl  = "https://" + jhRealm + "/db/" + oppDbid + "?a=er&key=" + currRecKey;
                let jobUrl  = "https://" + jhRealm + "/db/" + jobDbid + "?a=er&key=" + currRecKey;
                let editUrl = currType === "opp" ? oppUrl : jobUrl;
                let action  = this.value ?? this.id;

                inTestEnv
                    ? action === "exit"
                        ? document.location.reload()
                        : ""
                    : action === "editRec"
                        ? currRecKey && currType ? window.open(editUrl)
                            : ""
                        : document.location.href = homeUrl;
            }

            (function setHandlers() {
                //Record Selector
                document.getElementById("oppID").addEventListener("change", resetWeeks); //Rec Selector

                let myJobFilter = document.getElementById('myJobs'); //User filter
                myJobFilter.addEventListener("click", getRecordList);
                myJobFilter.addEventListener("click", clearWeeks);

                let allJobFilter = document.getElementById("allJobs"); //all Jobs filter
                allJobFilter.addEventListener("click", getRecordList);
                allJobFilter.addEventListener("click", clearWeeks);

                document.getElementById("editRec").addEventListener("click", goToQuickBase); //Edit QB anchor

                //Rec select display type filter
                document.getElementById("oppsRadio").addEventListener("click", filterByType);
                document.getElementById("jobsRadio").addEventListener("click", filterByType);
                document.getElementById("bothRadio").addEventListener("click", filterByType);
                document.getElementById("alist").addEventListener("click", filterByOppStatus);
                document.getElementById("blist").addEventListener("click", filterByOppStatus);
                document.getElementById("bidout").addEventListener("click", filterByOppStatus);
                document.getElementById("allBids").addEventListener("click", filterByOppStatus);

                //Start_End Dates
                let db = document.getElementById('date_beginning');
                db.addEventListener("change", showUpdate);
                db.addEventListener("change", setEndByDuration);
                document.getElementById("date_ending").addEventListener("change", showUpdate)

                //Set by duration or date
                let endType = document.getElementById("duration_weeks");
                endType.addEventListener("click", setEndByDuration);
                endType.addEventListener("click", showUpdate);

                document.getElementById("we_date").addEventListener("click", changeWkEndType);
                document.getElementById("we_duration").addEventListener("click", changeWkEndType);

                //manpower
                document.getElementById("totalMpwr").addEventListener("change", getMpwrTotal);
                document.getElementById("evenSplit").addEventListener("click", showUpdate);

                //update button
                document.getElementById("update").addEventListener("click", updateWeeks);

                //Action Buttons
                document.getElementById("finishBtn").addEventListener("click", genUpsert); //Exit app btn
                document.getElementById("clearBtn").addEventListener("click", clearMpwr); //Exit app btn
                document.getElementById("resetBtn").addEventListener("click", resetWeeks); //Exit app btn
                document.getElementById("exitBtn").addEventListener("click", goToQuickBase); //Exit app btn
                //modal
                document.getElementById("closeModal").addEventListener("click", hideModalButtons); //Exit app btn
                document.getElementById("refreshPageBtn").addEventListener("click", function () { location.reload() }); //Exit app btn
                document.getElementById("exitModal").addEventListener("click", goToQuickBase); //Exit app btn
            })();
        });
    </script>
</head>

<body>
    <div class="MainContent container-fluid">
        <!--Record Information and Header-->
        <div class="header sticky-top">
            <div class="row justify-content-between">
                <div class="col-6-auto">
                    <div class="logo">
                        <h2>Janotta &amp; Herner</h2>
                    </div>
                    <div id="lbrResults">
                        <h5 style="display:inline-block">Labor Projections For:</h5>
                        <span>
                            <input type="radio" tabindex="-1" id="myJobs" name="searchType" value="user" checked />
                            <label for="myJobs">My Jobs/Opps</label>
                            <input type="radio" tabindex="-1" id="allJobs" name="searchType" value="all" />
                            <label for="myJobs">All Jobs/Opps</label>
                        </span>
                        <div id="recLoad"> 
                            <span class="loadText"> Loading record list... </span>
                            <div id="loadSpinner" class="spinner-border spinner-border-sm text-warning" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                        <div id="recSelector" class="hide">
                            <select id="oppID" class="selectpicker">
                                <option value="select" class="hide" title="Select One">Select One...</option>
                                <optgroup id="jobList" label="Job(Weeks)"></optgroup>
                                <optgroup id="oppList" label="Opportunity(Weeks)">
                                </optgroup>
                            </select>
                            <span id="recordTypeSelector">
                                <span><strong>Display:</strong></span>
                                <input type="radio" tabindex="-1" id="oppsRadio" name="recordType" value="opps" />
                                <label for="oppsRadio">Opportunities</label>
                                <input type="radio" tabindex="-1" id="jobsRadio" name="recordType" value="jobs" />
                                <label for="jobsRadio">Jobs</label>
                                <input type="radio" tabindex="-1" id="bothRadio" name="recordType" value="both" checked />
                                <label for="bothRadio">Both</label>
                            </span>
                            <div id="oppStatus">
                                <input type="radio" tabindex="-1" id="alist" name="oppStatus" value="a" />
                                <label for="alist">A-List</label>
                                <input type="radio" tabindex="-1" id="blist" name="oppStatus" value="b" />
                                <label for="blist">B-List</label>
                                <input type="radio" tabindex="-1" id="bidout" name="oppStatus" value="o"  />
                                <label for="bidout">Bids Outstanding</label>
                                <input type="radio" tabindex="-1" id="allBids" name="oppStatus" value="all" checked/>
                                <label for="allBids">All Bids</label>
                            </div>
                        </div>
                        <div id="viewOpp"><a style="color: rgb(227, 112, 39)" href="#" id="editRec" tabindex="-1">Edit QB Record</a></div>
                    </div>
                    <!--Begin User Input and Control-->
                    <div class="durationChanges row">
                        <div class="staticinput col-auto" id="start">
                            <label class="datetip" for="date_beginning">
                                Week Beginning &#10068;
                                <span class="datetiptext row col-xlg">
                                    When selecting dates, if the date chosen is not a "Monday", <br />
                                    the date will automatically be changed to the Monday of that week. <br />
                                    If the date chosen is a "Sunday", the date will be changed to the <br />
                                    following Monday (i.e. the next day).
                                </span>
                            </label>
                            <input class="form-control" type="date" id="date_beginning" />
                        </div>
                        <div class="staticinput col-auto" id="wkending">
                            <div id="wkendbydate">
                                <label for="date_ending">Week Ending</label>
                                <input type="date" class="form-control" id="date_ending" />
                            </div>
                            <div class="hide" id="wkendbyduration">
                                <label for="date_ending">Week Ending</label>
                                <input type="number" class="form-control" id="duration_weeks" placeholder="# of Weeks" />
                            </div>
                            <span style="padding:5px">
                                By:
                                <input type="radio" tabindex="-1" id="we_date" name="we_type" value="byDate" checked />
                                <label for="we_date">Date</label>
                                <input type="radio" tabindex="-1" id="we_duration" name="we_type" value="byDuration" />
                                <label for="we_duration">Duration</label>
                            </span>
                        </div>
                        <div class="staticinput col-auto" id="mpwr">
                            <label for="totalMpwr">Total Manpower Needed</label>
                            <input type="number" class="form-control" id="totalMpwr" />
                            <div class="staticinput">
                                <input type="checkbox" tabindex="-1" id="evenSplit" />
                                <label for="evenSplit">Split Evenly</label>
                            </div>
                        </div>

                        <div class="staticinput col-auto" id="updateWeeks">
                            <button id="update" type="button" class="btn btn-warning hide">Update</button>
                            <span id="noSplit" class="warning hide">Cannot Split to whole #'s: Enter Manually</span>
                        </div>
                    </div>
                </div>
                <div id="datepicker" tabindex="-1" class="col-sm-auto"></div>
            </div>
            <div id="deleteWarning" class="warning hide">Warning: Records will be deleted if uploaded with the current dates.</div>
        </div>
        <!--Manpower Totals and Comparison Info-->
        <div class="laborDisplay">
            <div class="hide" id="noRecords"><p>No Records to update \_(&#12484;)_/</p></div>
            <div id="labor" class="hide">
                <div id="beginDates">
                    <!--Container to place all generated weeks-->
                    <div id="weeks"></div>
                </div>
            </div>
            <!--Clear and cancel options-->
            <div id="clearCancel" class="footer">
                <div id="mpwrComparison">
                    <div class="row">
                        <div class="col">Total Mpwr : <span class="col-2" id="hours"></span></div>
                    </div>
                    <div class="row">
                        <div class="col">Over/Under: <span class="col-2" id="hoursRemaining"></span></div>
                    </div>
                    <div id="mpwrMismatch" class="warning hide">
                        <span>Manpower totals do not match</span>
                    </div>
                </div>
                <div id="footerbuttons">
                    <button id="finishBtn" type="button" class="btn btn-success hide" title="Upload to QB">Upload Schedule</button>
                    <button id="clearBtn" type="button" class="btn btn-secondary" title="Clear Manpower in each week">Clear Manpower</button>
                    <button id="resetBtn" type="button" class="btn btn-warning" title="Resets back to current state in QB">Reset</button>
                    <button id="exitBtn" type="button" class="btn btn-danger" title="Exit back to QB" value="exit">Exit</button>
                </div>
            </div>
        </div>
        <!--Modal Popup On Submission and Response-->
        <div id="loadScreen" class="modal fade" role="dialog" data-backdrop="static">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="modalTitle" class="modal-title"></h2>
                    </div>
                    <div class="modal-body">
                        <p id="modal-message"></p>
                    </div>
                    <div class="modal-footer">
                        <button id="closeModal" type="button" class="btn btn-secondary hide" data-dismiss="modal">Continue</button>
                        <button id="refreshPageBtn" type="button" class="btn btn-primary hide">Refresh</button>
                        <button id="exitModal" type="button" class="btn btn-danger hide" data-dismiss="modal" value="exit">Exit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>