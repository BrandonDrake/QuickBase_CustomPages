<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="utf-8" />
    <title>JH Labor Projection Manager</title>

    <!-- External Dependencies & CSS -->
    <link rel="stylesheet" href="https://jhigroup.quickbase.com/db/bpmpd3j2a?a=dbpage&pageID=45" />
    <script src="https://cdn.jsdelivr.net/npm/luxon@1.24.1/build/global/luxon.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
            integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
          integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z"
          crossorigin="anonymous">

    <!-- JS Source Code Begins -->
    <script>
        //Testing Modules and DBIDs
        let inTestEnv = window.location.href.startsWith("http://localhost");
        let inSandbox = false; //If testing labor in Sanbox
        let useJobModule = window.location.href.startsWith("http://localhost"); //Labor Projections for jobs is live
        let jhRealm = "realm.quickbase.com";
        let laborDbid = "someDBID" /* DO NOT CHANGE */
        let laborSandboxDbid = "someDBID"; //USE SANBOXED LABOR NEEDS DBID - Can Change
        let oppDbid = "someDBID"; /* DO NOT CHANGE */
        let jobDbid = "someDBID"; /* DO NOT CHANGE */
        let errorDbid = "someDBID"; /* DO NOT CHANGE */

        //Globals
        let DateTime = luxon.DateTime;
        let today = DateTime.local();
        let laborToken = "";
        let oppToken = "";
        let jobToken = "";
        let errorsToken = "";
        let tokenRuns = 0;
        let tokenRefresh = "";
        let isDirectEdit = window.location.hash; //User Passed in a record key for direct edit
        let currRecKey = isDirectEdit ? window.location.hash.split("#")[1] : "";
        let currType = "";
        let recList = [];
        let currWeeks = [];
        let oppRecsReturned = 0;
        let jobRecsReturned = 0;
        let dateUpdated = false;
        let changesMade = false;
        let oppInfoUpdated = false;

        window.addEventListener('load', () => {
            //===== Embed Jquery UI Calendar
            $(function () {
                $("#datepicker").datepicker();
            });

            //Init Bootstrap tooltips
            $(function () {
                $('[data-toggle="tooltip"]').tooltip()
            })

            //===== Handle Promise Errors
            function handleError(response, method) {
                if (!response.ok) {
                    let userResponse = "Issues obtaining required information from " + method + ". Contact Brandon Drake and provide this information";
                    let logResponse = response.status + ": " + response.statusText + "(" + method + ")";
                    let body = [{ "6": { "value": logResponse } }];

                    applyUpsert(body, errorsToken, errorDbid);

                    throw Error(userResponse);
                }

                return response;
            }

            /**
             * id = jqueryID incl.#
             * action = "add" or "remove"
             *
             * @param id
             * @param action
             */
            function jqTogHide(id, action) {
                action === "remove"
                    ? $(id).removeClass("hide")
                    : $(id).addClass("hide");
            }

            //===== Obtain all initial tokens
            (async function getAllTokens() {
                let headers = {
                    'QB-Realm-Hostname': jhRealm,
                    'Content-Type': 'application/json'
                }

                let params = {
                    method: 'GET',
                    headers: headers,
                    credentials: 'include'
                }

                if (inTestEnv) {
                    tokenRuns === 0 ? recListResetAndRun() : console.log(tokenRuns);
                } else {
                    try {
                        const _getTokens = [
                            fetch('https://api.quickbase.com/v1/auth/temporary/' + laborDbid, params), //Labor Table
                            fetch('https://api.quickbase.com/v1/auth/temporary/' + oppDbid, params), //Opportunity Table
                            fetch('https://api.quickbase.com/v1/auth/temporary/' + jobDbid, params),  //Jobs Table
                            fetch('https://api.quickbase.com/v1/auth/temporary/' + errorDbid, params)  //Errors Table
                        ];
                        let res = await Promise.all(_getTokens);

                        await Promise.all(res.map(res => res.json()))
                            .then(keyArray => keyArray.map(key => key.temporaryAuthorization))
                            .then(keys => {
                                laborToken = keys[0];
                                oppToken = keys[1];
                                jobToken = keys[2];
                                errorsToken = keys[3];
                            });
                    } catch (e) {
                        tokenRuns < 5
                            ? getAllTokens()
                            : modalUpdate("999", "Error Obtaining tokens. Please contact Brandon Drake");
                    }
                }

                if (tokenRuns === 0 && !inTestEnv) {
                    recListResetAndRun() //Run initial fetch of records, other wise just update keys
                }

                if (tokenRuns < 12) {
                    tokenRuns++;
                    tokenRefresh = setTimeout(getAllTokens, 270000); //Continue to update tokens until user is idle for too long
                } else {
                    $("#resetBtn").addClass("hide");
                    $("#refreshPageBtn").removeClass("hide");
                    modalUpdate("999", "Idle for too Long. Please 'Refresh' or 'Exit' the page");
                }
            })();

            //Begin generating the record list
            function recListResetAndRun() {
                oppRecsReturned = 0;
                jobRecsReturned = 0;
                recList = [];

                //Update UI
                jqTogHide("#recSelector", "add");
                jqTogHide("#recLoad", "remove");
                $("option[id]").remove();

                if (inTestEnv) {
                    recList = [
                        { "proxy": "2020-ST-167:Some Opportunity 1", "duration": 0, "type": "opp", "constStart": "2021-12-01", "status": "A-List Active Bid", "probability": "10%", "oppValue": "12000", "totGuys": "0" },
                        { "proxy": "2020-JH-134:Some Opportunity 2", "duration": 0, "type": "opp", "constStart": "2021-12-01", "status": "B-List Active Bid", "probability": "50%", "oppValue": "128000", "totGuys": "0" },
                        { "proxy": "2020-JH-175:Some Opportunity 3", "duration": 0, "type": "opp", "constStart": "2021-12-02", "status": "O-Bid Outstanding", "probability": "90%", "oppValue": "1200000", "totGuys": "0" },
                        { "proxy": "2019-294 - My Contracted Job 1", "duration": 2, "type": "job", "constStart": "2021-12-01" },
                        { "proxy": "2018-391 - My COntracted Job 2", "duration": 11, "type": "job", "constStart": "2021-05-04", "constEndDate": "2021-08-04" }]
                    setTimeout(() => { buildRecSelector() }, 1500);
                } else {
                    // Check if users looking to edit record directly
                    if (isDirectEdit) {
                        $("#allJobs").prop("checked", true);
                        location.hash = "";
                        isDirectEdit = false
                    };

                    // Begin to obtain all jobs and opps
                    getOpps();
                }
            }

            //===== GET Opportunities
            function getOpps() {
                let headers = {
                    'QB-Realm-Hostname': jhRealm,
                    'Authorization': 'QB-TEMP-TOKEN ' + oppToken,
                    'Content-Type': 'application/json'
                }

                let params = {
                    'method': 'POST',
                    'headers': headers
                };


                let reportID = $("input[name='searchType']:checked").attr("value") === 'user' && !isDirectEdit ? 68 : 76;
                let oppURL = "https://api.quickbase.com/v1/reports/" + reportID + "/run?tableId=" + oppDbid + "&skip=";

                (function getOpps(url = oppURL, skip = 0) {
                    fetch(url + skip, params)
                        .then(response => handleError(response, "Record Selector"))
                        .then(response => response.json())
                        .then(data => {
                            let meta = {};
                            oppRecsReturned += data.metadata['numRecords'];
                            meta = { "totRecs": data.metadata['totalRecords'], "recsReturned": oppRecsReturned };
                            for (rec in data.data) {
                                let obj = {};
                                obj = {
                                    "proxy": data.data[rec][253].value,
                                    "duration": data.data[rec][235].value,
                                    "type": "opp",
                                    "constStart": data.data[rec][15].value,
                                    "status": data.data[rec][14].value,
                                    "probability": data.data[rec][13].value,
                                    "oppValue": data.data[rec][12].value,
                                    "totGuys": data.data[rec][273].value
                                };
                                recList.push(obj);
                            }
                            return meta;
                        }).then(meta => {
                            meta.totRecs === meta.recsReturned
                                ? useJobModule ? getJobs() : buildRecSelector()
                                : getOpps(oppURL, meta.recsReturned)
                        }).catch(err => { modalUpdate("999", err) });
                })();
            }

            //===== GET Jobs List
            function getJobs() {
                let headers = {
                    'QB-Realm-Hostname': jhRealm,
                    'Authorization': 'QB-TEMP-TOKEN ' + jobToken,
                    'Content-Type': 'application/json'
                }

                let params = {
                    'method': 'POST',
                    'headers': headers
                };

                let reportID = $("input[name='searchType']:checked").attr("value") === 'user' && !isDirectEdit ? 108 : 109;
                let jobURL = "https://api.quickbase.com/v1/reports/" + reportID + "/run?tableId=" + jobDbid + "&skip=";

                (function getJobs(url = jobURL, skip = 0) {
                    fetch(url + skip, params)
                        .then(response => handleError(response, "Record Selector"))
                        .then(response => response.json())
                        .then(data => {
                            let meta = {};
                            jobRecsReturned += data.metadata['numRecords'];
                            meta = { "totRecs": data.metadata['totalRecords'], "recsReturned": jobRecsReturned };
                            for (rec in data.data) {
                                let proxyID = 185;
                                let durationID = 512;
                                let constStart = 49;
                                let constEnd = 50;
                                let obj = {}
                                obj = { "proxy": data.data[rec][proxyID].value, "duration": data.data[rec][durationID].value, "type": "job", "constStart": data.data[rec][constStart].value, "projEndDate": data.data[rec][constEnd].value };
                                recList.push(obj);
                            }
                            return meta;
                        })
                        .then(meta => {
                            meta.totRecs === meta.recsReturned
                                ? buildRecSelector()
                                : getJobs(jobURL, meta.recsReturned)
                        })
                        .catch(err => { modalUpdate("999", err) });
                })();
            }

            //===== Build Record Selector Dropdown
            function buildRecSelector() {
                let oppGroup = $("#oppList");
                let jobGroup = $("#jobList");
                let oppOptions = [];
                let jobOptions = [];
                let type = "";

                //Build List
                for (let i = 0; i < recList.length; i++) {
                    type = recList[i].type;
                    let isOpp = type === "opp";

                    let listEL = document.createElement("option");
                    listEL.setAttribute("type", recList[i].type);
                    listEL.setAttribute("data-conststart", recList[i].constStart);
                    if (!isOpp) { listEL.setAttribute("data-constenddate", recList[i].constEndDate) };
                    listEL.setAttribute("class", "recoption");
                    listEL.value = listEL.id = isOpp
                        ? recList[i].proxy.split(":")[0]
                        : recList[i].proxy.split(" - ")[0];
                    listEL.innerHTML = (isOpp
                        ? recList[i].proxy.split(":")[2] : recList[i].proxy) + " (Duration: " + recList[i].duration + " Wks)";

                    if (recList[i].duration === 0 || recList[i].totGuys == 0) { listEL.setAttribute("class", "noLbr") };

                    if (listEL.id === currRecKey) { listEL.selected = "selected" };

                    if (isOpp) {
                        listEL.title = recList[i].status;
                        listEL.setAttribute("data-status", recList[i].status.split("-")[0].toLowerCase());
                        listEL.setAttribute("data-probability", recList[i].probability);
                        listEL.setAttribute("data-oppvalue", recList[i].oppValue);
                        oppOptions.push(listEL)
                    } else {
                        jobOptions.push(listEL);
                    }
                }
                oppGroup.append(oppOptions);

                useJobModule
                    ? jobGroup.append(jobOptions)
                    : (() => {
                        $("#jobsRadio, #bothRadio").prop("disabled", true);
                        $("label[for='jobsRadio'], label[for='bothRadio'").attr("title", "Coming Soon");
                        $("#oppsRadio").prop("checked", true);
                        jqTogHide("#jobList", "add");
                    })();

                //Update UI
                recList.length ? jqTogHide("#noRecords", "add") : jqTogHide("#noRecords", "remove");
                jqTogHide("#recLoad", "add");
                jqTogHide("#recSelector", "remove");
                currRecKey ? fetchMpwr() : jqTogHide("#noRecords", "remove");
                $("optgroup option").even().addClass("recEvenOption");
            }

            //===== GET Opportunity Manpower weeks and totals
            function fetchMpwr() {
                let recordKey = $("#recordKey option:selected").attr("id");
                let type = $("#recordKey option:selected").attr("type");
                let constStart = $("#recordKey option:selected").attr("data-conststart");
                let constEndDate = $("#recordKey option:selected").attr("data-constenddate");
                let status = $("#recordKey option:selected").attr("title");
                let prob = $("#recordKey option:selected").attr("data-probability");
                let oppValue = $("#recordKey option:selected").attr("data-oppvalue");
                currRecKey = recordKey;
                currType = type;
                changesMade = false;
                tokenRuns = 1; //User interaction, reset token runs to 1 ensure they can keep working and not refresh the UI

                //Make sure that user wants to change before upload
                type === "job" ? $("#recordUpdates").addClass("hide") : $("#recordUpdates").removeClass("hide");
                jqTogHide("#labor", "add"); // HIde UI to prvent accidental changes
                $("#numGuysPerWeek, #totalMpwr, #duration_weeks").val("");
                $("#evenSplit").prop("checked", false);
                $("#duration_weeks").focus();
                $("#bidStatus").val(status);
                $("#probability").val(prob);
                $("#oppValue").val(oppValue);

                // Lookup record
                let keyID = type === "opp" ? "7" : "23";
                let query = "{" + keyID + ".EX." + recordKey + "}AND({12.GTE." + today + "}OR{12.IR.'this wk'})";
                let headers = {
                    'QB-Realm-Hostname': jhRealm,
                    'Authorization': 'QB-TEMP-TOKEN ' + laborToken,
                    'Content-Type': 'application/json'
                }

                let body = {
                    "from": laborDbid,
                    "select": [
                        3,
                        6,
                        7,
                        12,
                        36,
                        76,
                        77,
                        78,
                        79
                    ],
                    "where": query
                }

                let params = { method: 'POST', headers: headers, "body": JSON.stringify(body) };

                let URL = 'https://api.quickbase.com/v1/records/query';

                inTestEnv
                    ? buildMpwrImport({ //{ "data": [] }, constStart, constEndDate)
                        "data": [
                            {
                                "3": {
                                    "value": 149
                                },
                                "6": {
                                    "value": 4
                                },
                                "7": {
                                    "value": "2020-JH-113"
                                },
                                "12": {
                                    "value": "2021-01-04"
                                },
                                "36": {
                                    "value": "concrete"
                                },
                                "76": {
                                    "value": ""
                                },
                                "77": {
                                    "value": "concrete"
                                },
                                "78": {
                                    "value": ""
                                },
                                "79": {
                                    "value": ""
                                }
                            },
                            {
                                "3": {
                                    "value": 150
                                },
                                "6": {
                                    "value": 4
                                },
                                "7": {
                                    "value": "2020-JH-113"
                                },
                                "12": {
                                    "value": "2021-01-11"
                                },
                                "36": {
                                    "value": "vacation"
                                },
                                "76": {
                                    "value": "vacation"
                                },
                                "77": {
                                    "value": ""
                                },
                                "78": {
                                    "value": ""
                                },
                                "79": {
                                    "value": ""
                                }
                            },
                            {
                                "3": {
                                    "value": 151
                                },
                                "6": {
                                    "value": 4
                                },
                                "7": {
                                    "value": "2020-JH-113"
                                },
                                "12": {
                                    "value": "2021-01-18"
                                },
                                "36": {
                                    "value": ""
                                },
                                "76": {
                                    "value": ""
                                },
                                "77": {
                                    "value": ""
                                },
                                "78": {
                                    "value": ""
                                },
                                "79": {
                                    "value": ""
                                }
                            },
                            {
                                "3": {
                                    "value": 152
                                },
                                "6": {
                                    "value": 5
                                },
                                "7": {
                                    "value": "2020-JH-113"
                                },
                                "12": {
                                    "value": "2021-01-25"
                                },
                                "36": {
                                    "value": ""
                                },
                                "76": {
                                    "value": ""
                                },
                                "77": {
                                    "value": ""
                                },
                                "78": {
                                    "value": ""
                                },
                                "79": {
                                    "value": ""
                                }
                            },
                            {
                                "3": {
                                    "value": 153
                                },
                                "6": {
                                    "value": 5
                                },
                                "7": {
                                    "value": "2020-JH-113"
                                },
                                "12": {
                                    "value": "2021-02-01"
                                },
                                "36": {
                                    "value": ""
                                },
                                "76": {
                                    "value": ""
                                },
                                "77": {
                                    "value": ""
                                },
                                "78": {
                                    "value": ""
                                },
                                "79": {
                                    "value": ""
                                }
                            },
                            {
                                "3": {
                                    "value": 154
                                },
                                "6": {
                                    "value": 5
                                },
                                "7": {
                                    "value": "2020-JH-113"
                                },
                                "12": {
                                    "value": "2021-02-08"
                                },
                                "36": {
                                    "value": ""
                                },
                                "76": {
                                    "value": ""
                                },
                                "77": {
                                    "value": ""
                                },
                                "78": {
                                    "value": ""
                                },
                                "79": {
                                    "value": ""
                                }
                            },
                            {
                                "3": {
                                    "value": 155
                                },
                                "6": {
                                    "value": 5
                                },
                                "7": {
                                    "value": "2020-JH-113"
                                },
                                "12": {
                                    "value": "2021-02-15"
                                },
                                "36": {
                                    "value": ""
                                },
                                "76": {
                                    "value": ""
                                },
                                "77": {
                                    "value": ""
                                },
                                "78": {
                                    "value": ""
                                },
                                "79": {
                                    "value": ""
                                }
                            }
                        ],
                        "fields": [
                            {
                                "id": 3,
                                "label": "Record ID#",
                                "type": "recordid"
                            },
                            {
                                "id": 6,
                                "label": "Manpower",
                                "type": "numeric"
                            },
                            {
                                "id": 7,
                                "label": "Related Opportunity",
                                "type": "text"
                            },
                            {
                                "id": 12,
                                "label": "Related Weekday",
                                "type": "date"
                            },
                            {
                                "id": 36,
                                "label": "specialtyList",
                                "type": "text"
                            }
                        ],
                        "metadata": {
                            "numFields": 9,
                            "numRecords": 7,
                            "skip": 0,
                            "totalRecords": 7
                        }
                    })
                    : fetch(URL, params)
                        .then(response => handleError(response, "fetchMpwr"))
                        .then(response => response.json())
                        .then(data => buildMpwrImport(data, constStart, constEndDate))
                        .catch(err => { modalUpdate("999", err) });
            }

            /**
             * Builds the objects for each week returned from fetch
             *
             * @param response json from fetch
             * @param constStart QB start date for the record
             */
            function buildMpwrImport(response, constStart, constEndDate) {
                currWeeks = [];
                let existingWeeks = [];
                let data = response.data;

                if (data.length > 0) {

                    let startDate = data[0][12].value;
                    let endDate = data[data.length - 1][12].value;

                    for (let i = 0; i < data.length; i++) {
                        let existingWeek = {};
                        let dateBegin = data[i][12].value;
                        let mpwr = data[i][6].value;
                        let recPK = data[i][3].value;
                        let specialtyList = data[i][36].value;
                        let specDates = {
                            "vaca": data[i][76].value,
                            "concrete": data[i][77].value,
                            "masonry": data[i][78].value,
                            "drywall": data[i][79].value
                        };

                        existingWeek = { "date": dateBegin, "mpwr": mpwr, "recPK": recPK, "specialty": specialtyList, "specDates": specDates };
                        existingWeeks.push(existingWeek);
                    }

                    currWeeks = existingWeeks;
                    if ($(".week").length) { clearWeeks() };
                    genWeeksBegin(startDate, endDate, existingWeeks);
                } else {
                    clearWeeks();
                    constStart ?? constStart >= today.toISODate()
                        ? $("#date_beginning").val(constStart)
                        : "";
                    constEndDate ?? constEndDate >= today.toISODate()
                        ? $("#date_ending").val(constEndDate)
                        : "";
                    getMpwrTotal();
                }
            }

            /**
             *  Generate the weeks and manpower
             *
             * @param sd optional start date of job or opp
             * @param ed optional end date of job or opp
             */
            function genWeeksBegin(sd = null, ed = null) {
                //Select and Format Begin/End Dates
                let startDate = !sd ? DateTime.fromISO($("#date_beginning").val()) : DateTime.fromISO(sd);
                let endDate = !ed ? DateTime.fromISO($("#date_ending").val()) : DateTime.fromISO(ed);
                let weekCounter = 0;
                let weekList = [];

                if (sd) { $("#date_beginning").val(startDate.toISODate()); };
                if (ed) { $("#date_ending").val(endDate.toISODate()); }

                //Check for if rec contains specialty crew dates
                let hasSpecialty = function (spec, specList, start) {
                    if (specList.includes(spec.value) && start.toISODate() === currWeeks[weekCounter].date) {
                        spec.setAttribute("checked", true);
                        return true;
                    } else { return false };
                }

                let genDateList = function (specType, week, res) {
                    let datesList = document.createElement("span");
                    datesList.id = specType + "DateList" + week;
                    datesList.setAttribute("class", "dateList");
                    datesList.setAttribute("style", res ? "display: inline" : "display: none");
                    let toggleDateEntry = document.createElement("label");
                    toggleDateEntry.innerHTML = "&#9656;";
                    toggleDateEntry.id = specType + "Exp" + week;
                    toggleDateEntry.setAttribute("action", "exp");
                    toggleDateEntry.setAttribute("class", "specDateDisplay");
                    toggleDateEntry.setAttribute("style", "display: inline");
                    toggleDateEntry.setAttribute("title", "Toggle Date Box");
                    toggleDateEntry.addEventListener("click", () => { $(toggleDateEntry).siblings("input").toggle(); });
                    let dateEntry = document.createElement("input");
                    dateEntry.setAttribute("placeholder", "ex. 1/1,3-5,7");
                    dateEntry.setAttribute("class", "dateEntry");
                    dateEntry.setAttribute("type", "text");
                    dateEntry.id = specType + "Dates" + week;
                    dateEntry.setAttribute("style", "display: none");
                    dateEntry.setAttribute("size", "10");
                    dateEntry.addEventListener("change", () => { changesMade = true; })
                    res ? dateEntry.value = currWeeks[week].specDates[specType] : "";

                    datesList.appendChild(toggleDateEntry);
                    //datesList.appendChild(minimize);
                    datesList.appendChild(dateEntry);

                    return datesList;
                }

                try {
                    if (checkDates(startDate, endDate)) {
                        jqTogHide("#noRecords", "add");
                        while (startDate <= endDate) {
                            let dateDisplay = document.createElement("label");
                            let manpwrInput = document.createElement("input");
                            let specialty = document.createElement("div");
                            specialty.setAttribute("class", "specialtyselector");
                            let specDates = document.createElement("div");
                            let highMpwr = document.createElement("span");
                            let weekDiv = document.createElement("span");
                            let specList = weekCounter < currWeeks.length ? currWeeks[weekCounter].specialty : "";

                            (function buildDate() {
                                //Date Attributes
                                dateDisplay.id = "D" + weekCounter;
                                dateDisplay.innerHTML = startDate.toLocaleString();
                                dateDisplay.setAttribute("class", "dateLabel");
                                dateDisplay.setAttribute("name", startDate.toISODate());
                                dateDisplay.setAttribute("for", "M" + weekCounter);
                                currWeeks.length && weekCounter < currWeeks.length ? dateDisplay.setAttribute("data-recPK", currWeeks[weekCounter].recPK) : "";
                            })();

                            (function buildMpwr() {
                                //Manpower Element Attributes
                                manpwrInput.setAttribute("class", "form-control mpwrInput");
                                manpwrInput.type = "number";
                                manpwrInput.id = "M" + weekCounter;
                                manpwrInput.setAttribute("data-date", startDate.toLocaleString());
                                manpwrInput.addEventListener("change", () => { changesMade = true; checkEntry });
                                manpwrInput.addEventListener("focus", updateCalendar)
                                highMpwr.className = "highMpwr hide warning";
                            })();

                            (function buildVaca() {
                                //Specialty Selectors
                                let v = document.createElement("span");
                                let vacation = document.createElement("input");
                                vacation.setAttribute("type", "checkbox");
                                vacation.id = "vaca" + weekCounter;
                                vacation.setAttribute("value", "vacation");
                                vacation.setAttribute("class", "specialty");
                                vacation.setAttribute("tabindex", "-1");
                                vacation.setAttribute("data-toggle", "tooltip");
                                vacation.setAttribute("data-placement", "top");
                                vacation.setAttribute("data-startMonth", startDate.toFormat("MM"));
                                vacation.setAttribute("title", "Vacation");
                                vacation.addEventListener("change", () => {
                                    changesMade = true;
                                    let vacaSib = $(vacation).siblings("span.dateList")
                                    vacaSib.toggle().children("input").toggle();
                                    let val = vacaSib.children("input.dateEntry");
                                    val.focus();
                                    val.val() === "" ? val.val($(vacation).attr("data-startMonth") + "/") : val.val();
                                });
                                let res = hasSpecialty(vacation, specList, startDate);
                                let vlabel = document.createElement("label");
                                vlabel.setAttribute("for", "vaca" + weekCounter);
                                vlabel.setAttribute("class", "speclabel");
                                vlabel.innerHTML = "V";
                                v.appendChild(vacation);
                                v.appendChild(vlabel);
                                v.appendChild(genDateList("vaca", weekCounter, res));
                                specialty.appendChild(v);
                            })();

                            (function buildConcrete() {
                                let c = document.createElement("span");
                                let concrete = document.createElement("input");
                                concrete.setAttribute("type", "checkbox");
                                concrete.id = "concrete" + weekCounter;
                                concrete.setAttribute("value", "concrete");
                                concrete.setAttribute("class", "specialty");
                                concrete.setAttribute("tabindex", "-1");
                                let res = hasSpecialty(concrete, specList, startDate);
                                concrete.setAttribute("data-toggle", "tooltip");
                                concrete.setAttribute("data-placement", "top");
                                concrete.setAttribute("data-startMonth", startDate.toFormat("MM"));
                                concrete.setAttribute("title", "Concrete");
                                concrete.addEventListener("change", () => {
                                    changesMade = true;
                                    let concSib = $(concrete).siblings("span.dateList")
                                    concSib.toggle().children("input").toggle();
                                    let val = concSib.children("input.dateEntry");
                                    val.focus();
                                    val.val() === "" ? val.val($(concrete).attr("data-startMonth") + "/") : val.val();
                                });
                                let clabel = document.createElement("label");
                                clabel.setAttribute("for", "concrete" + weekCounter);
                                clabel.setAttribute("class", "speclabel");
                                clabel.innerHTML = "C";
                                let cDates = document.createElement("input");
                                cDates.setAttribute("type", "text");
                                cDates.id = "cDates" + weekCounter;
                                cDates.setAttribute("class", "hide");
                                c.appendChild(concrete);
                                c.appendChild(clabel);
                                c.appendChild(cDates);
                                c.appendChild(genDateList("concrete", weekCounter, res));
                                specialty.appendChild(c);
                            })();

                            (function buildMasonry() {
                                let m = document.createElement("span");
                                let masonry = document.createElement("input");
                                masonry.setAttribute("type", "checkbox");
                                masonry.id = "masonry" + weekCounter;
                                masonry.setAttribute("value", "masonry");
                                masonry.setAttribute("class", "specialty");
                                masonry.setAttribute("tabindex", "-1");
                                masonry.setAttribute("data-toggle", "tooltip");
                                masonry.setAttribute("data-placement", "top");
                                masonry.setAttribute("data-startMonth", startDate.toFormat("MM"));
                                masonry.setAttribute("title", "Masonry");
                                masonry.addEventListener("change", () => {
                                    changesMade = true;
                                    let masonSib = $(masonry).siblings("span.dateList")
                                    masonSib.toggle().children("input").toggle();
                                    let val = masonSib.children("input.dateEntry");
                                    val.focus();
                                    val.val() === "" ? val.val($(masonry).attr("data-startMonth") + "/") : val.val();
                                });
                                let res = hasSpecialty(masonry, specList, startDate);
                                let mlabel = document.createElement("label");
                                mlabel.setAttribute("for", "masonry" + weekCounter);
                                mlabel.setAttribute("class", "speclabel");
                                mlabel.innerHTML = "M";
                                let mDates = document.createElement("input");
                                mDates.setAttribute("type", "text");
                                mDates.id = "mDates" + weekCounter;
                                mDates.setAttribute("class", "hide");
                                m.appendChild(masonry);
                                m.appendChild(mlabel);
                                m.appendChild(mDates);
                                m.appendChild(genDateList("masonry", weekCounter, res));
                                specialty.appendChild(m);
                            })();

                            (function buildDrywall() {
                                let d = document.createElement("span");
                                let drywall = document.createElement("input");
                                drywall.setAttribute("type", "checkbox");
                                drywall.id = "drywall" + weekCounter;
                                drywall.setAttribute("value", "drywall");
                                drywall.setAttribute("class", "specialty");
                                drywall.setAttribute("tabindex", "-1");
                                drywall.setAttribute("data-toggle", "tooltip");
                                drywall.setAttribute("data-placement", "top");
                                drywall.setAttribute("data-startMonth", startDate.toFormat("MM"));
                                drywall.setAttribute("title", "Drywall");
                                drywall.addEventListener("change", () => {
                                    changesMade = true;
                                    let drySib = $(drywall).siblings("span.dateList")
                                    drySib.toggle().children("input").toggle();
                                    let val = drySib.children("input.dateEntry");
                                    val.focus();
                                    val.val() === "" ? val.val($(drywall).attr("data-startMonth") + "/") : val.val();
                                });
                                let res = hasSpecialty(drywall, specList, startDate);
                                let dlabel = document.createElement("label");
                                dlabel.setAttribute("for", "drywall" + weekCounter);
                                dlabel.setAttribute("class", "speclabel");
                                dlabel.innerHTML = "D";
                                let dDates = document.createElement("input");
                                dDates.setAttribute("type", "text");
                                dDates.id = "dDates" + weekCounter;
                                dDates.setAttribute("class", "hide");
                                d.appendChild(drywall);
                                d.appendChild(dlabel);
                                d.appendChild(dDates);
                                d.appendChild(genDateList("drywall", weekCounter, res));
                                specialty.appendChild(d);
                            })();

                            (function buildWeek() {
                                weekDiv.setAttribute("class", "week");
                                weekDiv.id = "W" + weekCounter;
                                weekDiv.appendChild(dateDisplay);
                                weekDiv.appendChild(manpwrInput);
                                if (currType === "job") { weekDiv.appendChild(specialty); weekDiv.appendChild(specDates) };
                                weekDiv.appendChild(highMpwr);
                            })();

                            //Generate Data array
                            weekList.push(weekDiv);
                            //Increment values
                            startDate = startDate.plus({ days: 7 });
                            weekCounter++;
                        }
                        $("#weeks").prepend(weekList);

                        //Auto set manpower fields if split checkbox is checked
                        popManpower();

                        //Display Results
                        jqTogHide("#labor", "remove");
                        $("#finishBtn").prop("disabled", false);
                        $("#finishBtn").attr("title", "Upload to QB");

                        //Update UI
                        $(".week").even().addClass("even");
                        $("#we_duration").prop("checked", true);
                        $(weekList).length
                            ? $("#M0").focus()
                            : $("#duration_weeks").focus();
                        weekCounter < currWeeks.length ? jqTogHide("#deleteWarning", "remove") : jqTogHide("#deleteWarning", "add");

                        //Get new totals (if any)
                        getMpwrTotal();
                        changeWkEndType();
                    }
                } catch {
                    modalUpdate("999", "Error Loading Week Begin Dates. Please contact Brandon Drake ext. 266.")
                };
            }

            //===== Repopulates the Manpower after duration update to just fill weeks from beginnning
            function popManpower() {
                let newDuration = $(".week").length;
                let numGuys = parseInt($("#numGuysPerWeek").val()) ?? null;

                if (numGuys >= 0) {
                    $(".week").each(function (index) {
                        let mpwr = $(this).find(".mpwrInput");
                        mpwr.val(numGuys);
                    });
                } else if (newDuration === currWeeks.length) {
                    $(".week").each(function (index) {
                        let mpwr = $(this).find(".mpwrInput");
                        mpwr.val(currWeeks[index].mpwr);
                    });
                } else {
                    for (let i = 0; i < currWeeks.length; i++) {
                        $(".week").each(function () {
                            let mpwr = $(this).find(".mpwrInput");
                            let date = $(this).find("label").attr("name");

                            if (currWeeks[i].date === date) {
                                mpwr.val(currWeeks[i].mpwr);
                            }
                        })
                    }
                }

                $("#preFill").prop("checked", false);
            }

            /**
             * Check the start and end dates
             *
             * @param startDate Start date passed in by user
             * @param endDate End Date passed in by user (or by duration)
             *
             * @returns boolean Returns true if date tests match
             */
            function checkDates(startDate, endDate) {
                let startWeek = startDate.toFormat("WW");
                let currWeek = today.toFormat("WW");
                let invalidStart = startDate < today && startWeek != currWeek;
                let invalidEnd = startDate > endDate;

                // Start check
                if (invalidStart) {
                    $("#start span.invalidStart").length ? "" : $("#start label").append("<span class=invalidStart></span>");
                } else {
                    $("#start span.invalidStart").remove()
                }

                // End check
                if (invalidEnd) {
                    $("#end span.invalidEnd").length ? "" : $("#end label").append("<span class=invalidEnd></span>");
                } else { $("#end span.invalidEnd").remove() }

                return (invalidStart || invalidEnd)
                    ? false //Dates not correct
                    : true //All dates valid to proceed
            }

            //===== Updates Calendar to follow the selected manpower week begin
            function updateCalendar() {
                let date = $(this).attr("data-date");

                $("#datepicker").datepicker("setDate", date);
            }

            //===== Check Mpwr Entry for large values
            function checkEntry() {
                let value = this.value;
                let id = this.id;
                parseInt(value) < 30
                    ? $("#" + id).siblings(".highMpwr").addClass("hide")
                    : $("#" + id).siblings(".highMpwr").removeClass("hide").val("Seems High");

                getMpwrTotal();
            }

            //===== Calculate Total Manpower
            function getMpwrTotal() {
                let totalMpwr = 0;
                let mpwrJQ = $("#hours");

                $(".week").each(function (index) {
                    let mpwr = Math.round($("#M" + index).val());
                    totalMpwr += mpwr;
                });

                //Set New Values
                mpwrJQ.text(totalMpwr);
            }

            //===== Updates Labor Weeks with new data
            function updateWeeks() {
                let updatedStart = DateTime.fromISO($("#date_beginning").val());
                let updatedEnd = DateTime.fromISO($("#date_ending").val());
                let startDay = updatedStart.toFormat("c");
                let endDay = updatedEnd.toFormat("c");

                //Adjust start to beginning of week
                switch (startDay) {
                    case "1": //Monday
                        updatedStart = updatedStart;
                        break;
                    case "2":
                        updatedStart = updatedStart.minus({ days: 1 });
                        break;
                    case "3":
                        updatedStart = updatedStart.minus({ days: 2 });
                        break;
                    case "4":
                        updatedStart = updatedStart.minus({ days: 3 });
                        break;
                    case "5":
                        updatedStart = updatedStart.minus({ days: 4 });
                        break;
                    case "6":
                        updatedStart = updatedStart.minus({ days: 5 });
                        break;
                    case "7": //Sunday
                        updatedStart = updatedStart.plus({ days: 1 });
                        break;
                    default:
                        console.log("Error With conversion");
                };

                //Adjust start to beginning of week
                switch (endDay) {
                    case "1": //Monday
                        updatedEnd = updatedEnd;
                        break;
                    case "2":
                        updatedEnd = updatedEnd.minus({ days: 1 });
                        break;
                    case "3":
                        updatedEnd = updatedEnd.minus({ days: 2 });
                        break;
                    case "4":
                        updatedEnd = updatedEnd.minus({ days: 3 });
                        break;
                    case "5":
                        updatedEnd = updatedEnd.minus({ days: 4 });
                        break;
                    case "6":
                        updatedEnd = updatedEnd.minus({ days: 5 });
                        break;
                    case "7": //Sunday
                        updatedEnd = updatedEnd.plus({ days: 1 });
                        break;
                    default:
                        console.log("Error With conversion");
                }

                $("#date_beginning").val(updatedStart.toISODate());
                $("#date_ending").val(updatedEnd.toISODate());

                if (checkDates(updatedStart, updatedEnd)) {
                    $(".week").remove();
                    $("#update").prop("disabled", true);
                    genWeeksBegin();
                    getMpwrTotal();
                }
            }

            //===== Display Update Weeks Button if any field changes
            function requireUpdate() {
                let totWeeks = $(".week").length;
                let userDuration = parseInt($("#duration_weeks").val())
                let currStart = $("#D0").attr("name");
                let currEnd = $("#D" + (totWeeks - 1)).attr("name");
                let startMatch = $("#date_beginning").val() === currStart;
                let endMatch = $("#date_ending").val() === currEnd;
                let durationMatch = userDuration === totWeeks;
                changesMade = true;

                dateUpdated = !startMatch || !endMatch || !durationMatch;

                if (dateUpdated) {
                    $("#update").prop("disabled", false);
                    $("#finishBtn").prop("disabled", true);
                    $("#finishBtn").attr("title", "Update Required for Upload");
                } else if ($("#numGuysPerWeek").val() != "" || totWeeks !== $(".week").length) {
                    $("#update").prop("disabled", false);
                    $("#finishBtn").prop("disabled", true);
                    $("#finishBtn").attr("title", "Update Required for Upload");
                } else {
                    $("#update").prop("disabled", true);
                    $("#finishBtn").prop("disabled", false);
                    $("#finishBtn").attr("title", "Upload to QB");
                }
            }

            //===== Set the end date when duration is used
            function setEndByDuration() {
                let duration = $("#duration_weeks").val();
                let startDate = DateTime.fromISO($("#date_beginning").val());
                let endDate = startDate.plus({ weeks: duration - 1 }).toISODate();

                if (startDate.isValid && duration) {
                    $("#date_ending").val(endDate);
                }
            }

            //===== Change UI for setting job duration
            function changeWkEndType() {
                let startDate = DateTime.fromISO($("#date_beginning").val());
                let endDate = DateTime.fromISO($("#date_ending").val());
                let dateDuration = endDate.diff(startDate, 'weeks').toObject().weeks + 1;
                let setByDuration = $("#wkendbyduration");
                let setByDate = $("#wkendbydate");
                let numWeeks = $(".week").length;
                let isByDuration = $("#we_duration").is(":checked");

                if (isByDuration) {
                    (dateDuration) != numWeeks ? $("#duration_weeks").val(dateDuration) : $("#duration_weeks").val(numWeeks);
                    setByDuration.removeClass("hide");
                    setByDate.addClass("hide");
                    setByDuration.prop("checked", true);
                } else {
                    setByDuration.addClass("hide");
                    setByDate.removeClass("hide");
                    setByDate.prop("checked", true);
                }
            }

            //===== Clear manpower totals
            function clearMpwr() {
                $(".week .mpwrInput").val("");
                $("#M0").focus();
                getMpwrTotal();
            }

            //===== Clear All Data
            function clearWeeks() {
                $(".week").remove();
                $("#date_beginning, #date_ending, #totalMpwr").val("");
                $("#evenSplit").prop("checked", false);
                $("#finishBtn").prop("disabled", true);
                $("#finishBtn").attr("title", "Update Required for Upload");
                $("#start p.invalidStart, span.invalidEnd, span.invalidDay").remove();
                $("#end p.invalidStart, span.invalidEnd, span.invalidDay").remove();
                $("#hoursRemaining, #hours").val("");
            }

            //===== Reset weeks
            function resetWeeks() {
                $("#update").prop("disabled", true);
                fetchMpwr()
            }

            /** Updates the Modal Window to inform User of status
             *
             * @param status Return Status of the http request
             * @param requestMessage Mesage to be displayed based on the response status
             * @param toDelete Passes in num of records to be deleted
             */
            function modalUpdate(status, requestMessage = "", toDelete = 0) {
                let message = $("#modal-message");
                let title = $("#modalTitle");
                title.text("");
                message.text("");

                $("#loadScreen").modal("toggle");

                if (typeof failCounter == 'undefined') {
                    failCounter = 0;
                }
                if (status >= 200 && status < 400) {
                    let messageText = requestMessage === "Upload" ? "Uploading..." : "Uploading & Deleting " + toDelete + " week/s..."
                    title.text("Updating Labor Projections");
                    message.text(messageText);
                    setTimeout(function () {
                        if (!inTestEnv) {
                            let labrReport = window.open("https://jhigroup.quickbase.com/db/bqssicnr2?a=td", "com.jhigroup.LaborScheduler");
                            labrReport.location.reload()
                        };
                        message.text("Update Sucessful.");
                        recListResetAndRun();
                        jqTogHide("#footerbuttons", "remove");
                        setTimeout(function () { $("#loadScreen").modal("toggle"); }, 500)
                    }, 1000);
                } else if (status === "401") {
                    title.text("Error");
                    message.text("Authorization Issue. Refreshing page to try again in 3 seconds");
                    setTimeout(function () {
                        message.text("Authorization Issue. Refreshing page to try again in 3 seconds");
                        $("#loadScreen").modal("toggle");
                        window.location.reload();
                    }, 3000);
                } else if (status === "999") {
                    title.text("Error")
                    message.text(requestMessage);
                    jqTogHide("#exitModal", "remove");
                    jqTogHide("#refreshPageBtn", "remove");
                } else if (failCounter === 0) {
                    title.text("Unsuccessful Upload")
                    message.text("Upload Failed. Lets try one more time. Close and try to 'Upload Schedule' Again");
                    jqTogHide("#closeModal", "remove");
                    failCounter++;
                } else {
                    title.text("Upload Failed");
                    message.text(requestMessage + "\nPlease take a screen shot or contact Brandon Drake \n(ext. 266)");
                    message.addClass("spaced");
                    jqTogHide("#closeModal", "remove");
                    jqTogHide("#exitModal", "remove");
                }
            }

            //===== Filter record results
            function filterByType() {
                jobList = $("#jobList");
                oppList = $("#oppList");
                let type = this.value;

                switch (type) {
                    case "opps":
                        oppList.removeClass("hide");
                        jobList.addClass("hide");
                        $("#oppStatus").removeClass("hide");
                        break;
                    case "jobs":
                        oppList.addClass("hide");
                        jobList.removeClass("hide");
                        $("#oppStatus").addClass("hide");
                        break;
                    case "both":
                        oppList.removeClass("hide");
                        jobList.removeClass("hide");
                        $("#oppStatus").removeClass("hide");
                        break;
                    default:
                }
            }

            //===== Filter Opps by type
            function filterByOppStatus() {
                let selection = this.value;
                let options = $("#oppList option");

                if (selection === "all") {
                    options.removeClass("hide");
                } else {
                    options.each(function () {
                        let status = $(this).attr("data-status");

                        status === selection
                            ? $(this).removeClass("hide")
                            : $(this).addClass("hide");
                    });
                }
            }

            //===== Hide Modal Buttons
            function hideModalButtons() {
                jqTogHide("#closeModal", "add");
                jqTogHide("#exitModal", "add");
                jqTogHide("#refreshPageBtn", "add");
            }

            //===== Navigate to opportunity in quickbase
            function goToQuickBase() {
                let action = this.value ?? this.id;
                let baseURL = "https://" + jhRealm + "/db/";
                let key = "&key=" + currRecKey;
                let viewEdit = action === "editRec" ? "?a=er" : "?a=dr"
                let oppUrl = baseURL + oppDbid + viewEdit + key;
                let jobUrl = baseURL + jobDbid + viewEdit + key;

                let url = currType === "opp" ? oppUrl : jobUrl;


                inTestEnv
                    ? action === "exit"
                        ? clearTimeout(tokenRefresh)
                        : ""
                    : action !== "exit"
                        ? currRecKey && currType ? window.open(url)
                            : ""
                        : document.location.href = baseURL + laborDbid;
            }

            //===== Generates the body of API Call
            function genUpsert() {
                let records = [];
                let relatedRecField = currType === "opp" ? "7" : "23";

                $(".week").each(function (index) {
                    let date = $("#D" + index).attr("name");
                    let mpwr = Math.round($("#M" + index).val());
                    let record = {};
                    let existingId = $("#D" + index).attr("data-recPK");

                    if (existingId) { record["3"] = { value: existingId } };
                    record[relatedRecField] = { value: currRecKey };
                    record["12"] = { value: date };
                    record["6"] = { value: mpwr };

                    if (currType === "job") {
                        $("#W" + index + " .specialty").each(function () {
                            let specType = $(this).val();
                            let isChecked = $(this).prop("checked");

                            switch (specType) {
                                case "vacation":
                                    record["32"] = { "value": isChecked };
                                    record["76"] = { "value": isChecked ? $("#vacaDates" + index).val() : "" }
                                    break;
                                case "concrete":
                                    record["33"] = { "value": isChecked };
                                    record["77"] = { "value": isChecked ? $("#concreteDates" + index).val() : "" }
                                    break;
                                case "masonry":
                                    record["34"] = { "value": isChecked };
                                    record["78"] = { "value": isChecked ? $("#masonryDates" + index).val() : "" }
                                    break;
                                case "drywall":
                                    record["35"] = { "value": isChecked };
                                    record["79"] = { "value": isChecked ? $("#drywallDates" + index).val() : "" }
                                    break;
                                default:
                                    break;
                            };
                        });
                    };

                    records.push(record);
                })

                if (!changesMade && !oppInfoUpdated) {
                    alert("No changes made. Nothing to upload.");
                } else {
                    jqTogHide("#footerbuttons", "add");
                    applyUpsert(records, laborToken, laborDbid);
                    if (oppInfoUpdated) {
                        updateOpportunity();
                    }
                }
            }

            /**
             *  Quick Base API to add records
             *
             * @param records Json build for body of POST
             * @param dbid the dbid to which the records will be added
             */
            function applyUpsert(records, token, dbid) {
                let headers = {
                    'QB-Realm-Hostname': jhRealm,
                    'Authorization': 'QB-TEMP-TOKEN ' + token,
                    'Content-Type': 'application/json'
                }

                let body = {
                    "to": dbid, "data":
                        records
                };


                if (inTestEnv) {
                    console.log(JSON.stringify(body));
                    modalUpdate("200", "Success")
                } else {
                    const xmlHttp = new XMLHttpRequest();
                    xmlHttp.open('POST', 'https://api.quickbase.com/v1/records', true);
                    for (const key in headers) {
                        xmlHttp.setRequestHeader(key, headers[key]);
                    }
                    xmlHttp.onreadystatechange = function () {
                        if (xmlHttp.readyState === XMLHttpRequest.DONE) {
                            let status = xmlHttp.status;
                            if (status === 0 || (status >= 200 && status < 400)) {
                                dbid != errorDbid
                                    ? $(".week").length < currWeeks.length
                                        ? deleteRecords()
                                        : modalUpdate(status, "Upload") //Update status to user
                                    : console.log("error logged")
                            } else {
                                modalUpdate(status, xmlHttp.responseText);
                            }
                        }
                    };
                    xmlHttp.send(JSON.stringify(body))
                }
            }

            // Update Opportunity Record Information
            function updateOpportunity() {
                let status = $("#bidStatus option:selected").val();
                let prob = $("#probability option:selected").val();
                let contractVal = Math.abs(parseInt($("#oppValue").val()));
                let currStart = $("#D0").attr("name");

                let headers = {
                    'QB-Realm-Hostname': jhRealm,
                    'Authorization': 'QB-TEMP-TOKEN ' + currType === "opp" ? oppToken : jobToken,
                    'Content-Type': 'application/json'
                }

                let oppBody = {
                    "to": oppDbid, "data":
                        [{
                            "93": {
                                "value": currRecKey
                            },
                            "12": {
                                "value": contractVal
                            },
                            "13": {
                                "value": prob
                            },
                            "14": {
                                "value": status
                            },
                            "15": {
                                "value": currStart
                            }
                        }]
                };

                let jobBody = {
                    "to": jobDbid, "data":
                        [{

                        }]
                };

                let bodyToUse = currType === "opp" ? oppBody : jobBody;

                let params = {
                    'method': 'POST',
                    'headers': headers,
                    'body': JSON.stringify(bodyToUse)
                };

                !inTestEnv
                    ? fetch('https://api.quickbase.com/v1/records', params)
                        .then(res => {
                            if (res.ok) {
                                return res.json().then(res => console.log(res));
                            }
                            return res.json().then(resBody => Promise.reject({ status: res.status, ...resBody }));
                        })
                        .catch(err => console.log(err))
                    : console.log(JSON.stringify(body));
            }

            //===== Delete Records
            function deleteRecords() {
                let currWeeksLength = currWeeks.length;
                let numRecToDelete = currWeeksLength - $(".week").length;
                let where = "";
                let keyID = currType === "opp" ? 7 : 23;

                for (let i = 1; i <= numRecToDelete; i++) {
                    let recPK = currWeeks[currWeeksLength - i].recPK;
                    let template = "({3.EX." + recPK + "} AND {" + keyID + ".EX." + currRecKey + "})";
                    let or = "OR";

                    i != numRecToDelete
                        ? where += template + or
                        : where += template
                }

                let headers = {
                    'QB-Realm-Hostname': jhRealm,
                    'Authorization': 'QB-TEMP-TOKEN ' + laborToken,
                    'Content-Type': 'application/json'
                }
                let body = {
                    "from": laborDbid,
                    "where": where
                }

                inTestEnv ? console.log(JSON.stringify(body)) :
                    fetch('https://api.quickbase.com/v1/records',
                        {
                            method: 'DELETE',
                            headers: headers,
                            body: JSON.stringify(body)
                        })
                        .then(response => handleError(response, "deleteRecords"))
                        .then(res => {
                            return res.json().then(res => console.log(res, body)).then(modalUpdate("200", "Delete", numRecToDelete))
                        })
                        .then()
                        .catch(err => { modalUpdate("999", err) });
            }

            (function setHandlers() {
                //Record Selector
                document.getElementById("recordKey").addEventListener("change", resetWeeks); //Rec Selector

                let myJobFilter = document.getElementById('myJobs'); //User filter
                myJobFilter.addEventListener("click", recListResetAndRun);
                myJobFilter.addEventListener("click", clearWeeks);

                let allJobFilter = document.getElementById("allJobs"); //all Jobs filter
                allJobFilter.addEventListener("click", recListResetAndRun);
                allJobFilter.addEventListener("click", clearWeeks);

                document.getElementById("viewRec").addEventListener("click", goToQuickBase); //Edit QB anchor
                document.getElementById("editRec").addEventListener("click", goToQuickBase); //Edit QB anchor

                //Rec select display type filter
                document.getElementById("oppsRadio").addEventListener("click", filterByType);
                document.getElementById("jobsRadio").addEventListener("click", filterByType);
                document.getElementById("bothRadio").addEventListener("click", filterByType);
                document.getElementById("alist").addEventListener("click", filterByOppStatus);
                document.getElementById("blist").addEventListener("click", filterByOppStatus);
                document.getElementById("bidout").addEventListener("click", filterByOppStatus);
                document.getElementById("allBids").addEventListener("click", filterByOppStatus);

                //Start_End Dates
                let db = document.getElementById('date_beginning');
                db.addEventListener("change", setEndByDuration);
                db.addEventListener("change", requireUpdate);
                db.addEventListener("change", () => { oppInfoUpdated = true });
                document.getElementById("date_ending").addEventListener("change", requireUpdate)

                //Set by duration or date
                let endType = document.getElementById("duration_weeks");
                endType.addEventListener("change", setEndByDuration);
                endType.addEventListener("change", requireUpdate);

                document.getElementById("we_date").addEventListener("click", changeWkEndType);
                document.getElementById("we_duration").addEventListener("click", changeWkEndType);

                //manpower
                document.getElementById("numGuysPerWeek").addEventListener("change", requireUpdate);

                //Opportunity
                document.getElementById("bidStatus").addEventListener("change", () => { oppInfoUpdated = true });
                document.getElementById("probability").addEventListener("change", () => { oppInfoUpdated = true });
                document.getElementById("oppValue").addEventListener("change", () => { oppInfoUpdated = true });

                //update button
                document.getElementById("update").addEventListener("click", updateWeeks);

                //Action Buttons
                document.getElementById("finishBtn").addEventListener("click", genUpsert); //Exit app btn
                document.getElementById("clearBtn").addEventListener("click", clearMpwr); //Exit app btn
                document.getElementById("resetBtn").addEventListener("click", resetWeeks); //Exit app btn
                document.getElementById("exitBtn").addEventListener("click", goToQuickBase); //Exit app btn
                document.getElementById("collapseHeader").addEventListener("click", () => $("#dataManipulation").toggle());

                //modal
                document.getElementById("closeModal").addEventListener("click", hideModalButtons); //Exit app btn
                document.getElementById("refreshPageBtn").addEventListener("click", function () { location.reload() }); //Exit app btn
                document.getElementById("exitModal").addEventListener("click", goToQuickBase); //Exit app btn
            })();
        });
    </script>
</head>
<body>
    <div class="MainContent container-fluid">
        <!--Record Information and Header-->
        <div class="header sticky-top">
            <div class="logo">
                <h2>Janotta &amp; Herner: Labor Projection Manager</h2>
            </div>
            <div class="search">
                <div id="recSearch">
                    <div id="lbrResults">
                        <h6 style="display:inline-block">Show:</h6>
                        <div>
                            <input type="radio" tabindex="-1" id="myJobs" name="searchType" value="user" checked />
                            <label for="myJobs">My Jobs/Opps</label>
                            <input type="radio" tabindex="-1" id="allJobs" name="searchType" value="all" />
                            <label for="allJobs">All Jobs/Opps</label>
                        </div>
                        <div>
                            <div class="filter"><h6>Filter By:</h6></div>
                            <div class="filter">
                                <div id="recordTypeSelector">
                                    <span>Types:</span>
                                    <input type="radio" tabindex="-1" id="oppsRadio" name="recordType" value="opps" checked />
                                    <label for="oppsRadio">Opportunities</label>
                                    <input type="radio" tabindex="-1" id="jobsRadio" name="recordType" value="jobs" />
                                    <label for="jobsRadio">Jobs</label>
                                    <input type="radio" tabindex="-1" id="bothRadio" name="recordType" value="both" />
                                    <label for="bothRadio">Both</label>
                                </div>
                                <div id="oppStatus">
                                    <span>Status:</span>
                                    <input type="radio" tabindex="-1" id="alist" name="oppStatus" value="a" />
                                    <label for="alist">A-List</label>
                                    <input type="radio" tabindex="-1" id="blist" name="oppStatus" value="b" />
                                    <label for="blist">B-List</label>
                                    <input type="radio" tabindex="-1" id="bidout" name="oppStatus" value="o" />
                                    <label for="bidout">Bids Outstanding</label>
                                    <input type="radio" tabindex="-1" id="allBids" name="oppStatus" value="all" checked />
                                    <label for="allBids">All Bids</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="recLoad">
                        <span class="loadText"> Loading record list... </span>
                        <div id="loadSpinner" class="spinner-border spinner-border-sm text-warning" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                    <div class="recordSelection">
                        <div id="recSelector" class="hide">
                            <select class="custom-select mr-1" id="recordKey">
                                <option value="select" class="hide" title="Select One">Select One...</option>
                                <optgroup id="jobList" label="Job(Coming Soon)"></optgroup>
                                <optgroup id="oppList" label="Opportunity(Weeks)">
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <a href="#" id="viewRec" tabindex="-1" class="qbAction" title="View the record in Quick Base">View in QB</a> |
                            <a href="#" id="editRec" tabindex="-1" class="qbAction" title="Edit the record in Quick Base">Edit in QB</a>
                        </div>
                    </div>
                </div>
                <div id="calender">
                    <div id="datepicker"></div>
                </div>
            </div>
            <!--Begin User Input and Control-->
            <div id="dataManipulation">
                <div class="userUpdate hide" id="recordUpdates">
                    <h5>Opportunity Data</h5>
                    <div class="laborData" id="statusEdit">
                        <label for="bidStatus">Status</label>
                        <div>
                            <select class="custom-select" id="bidStatus">
                                <option value="A-List Active Bid">A-List Active Bid</option>
                                <option value="B-List Active Bid">B-List Active Bid</option>
                                <option value="O-Bid Outstanding">O-Bid Outstanding</option>
                            </select>
                        </div>
                    </div>
                    <div class="laborData">
                        <label for="probability">Probability</label>
                        <div>
                            <select class="custom-select" id="probability">
                                <option value="0%">0%</option>
                                <option value="5%">5%</option>
                                <option value="10%">10%</option>
                                <option value="20%">20%</option>
                                <option value="30%">30%</option>
                                <option value="40%">40%</option>
                                <option value="50%">50%</option>
                                <option value="60%">60%</option>
                                <option value="70%">70%</option>
                                <option value="80%">80%</option>
                                <option value="90%">90%</option>
                                <option value="100%">100%</option>
                            </select>
                        </div>
                    </div>
                    <div class="laborData" id="oppValueEdit">
                        <label for="oppValue">Opportunity Value</label>
                        <div>
                            <input type="number" class="form-control" id="oppValue" />
                        </div>
                    </div>
                </div>
                <div class="userUpdate" id="durationChanges">
                    <h5>Labor Data</h5>
                    <div class="laborData" id="start">
                        <label class="datetip" for="date_beginning">
                            Week Beginning &#10068;
                            <span class="datetiptext">
                                When selecting dates, if the date chosen is not a "Monday", <br />
                                the date will automatically be changed to the Monday of that week. <br />
                                If the date chosen is a "Sunday", the date will be changed to the <br />
                                following Monday (i.e. the next day).
                            </span>
                        </label>
                        <input class="form-control" type="date" id="date_beginning" />
                    </div>
                    <div class="laborData" id="wkending">
                        <div class="hide" id="wkendbydate">
                            <label for="date_ending">Duration</label>
                            <input type="date" class="form-control" id="date_ending" />
                        </div>
                        <div id="wkendbyduration">
                            <label for="date_ending">Duration</label>
                            <input type="number" class="form-control" id="duration_weeks" placeholder="# of Weeks" />
                        </div>
                        <div style="padding:5px">
                            By:
                            <input type="radio" tabindex="-1" id="we_date" name="we_type" value="byDate" />
                            <label for="we_date">Date</label>
                            <input type="radio" tabindex="-1" id="we_duration" name="we_type" value="byDuration" checked />
                            <label for="we_duration"># Weeks</label>
                        </div>
                    </div>
                    <!--Autofill based on #guys/week-->
                    <div class="laborData" id="guysPerWeek">
                        <label for="numGuys"># Guys/Wk</label>
                        <input type="number" class="form-control" id="numGuysPerWeek" />
                    </div>
                    <div class="laborUpdate" id="updateWeeks">
                        <button id="update" type="button" class="btn btn-warning btn-sm" disabled>Update</button>
                    </div>
                </div>
            </div>
            <div id="deleteWarning" class="warning hide">Warning: Records will be deleted if uploaded with the current dates.</div>
            <div title="Collapse/Expand" class="headerToggle" id="collapseHeader"><label>&#8597;</label></div>
        </div>
        <!--Manpower Totals and Comparison Info-->
        <div class="laborDisplay">
            <div class="hide" id="noRecords"><p>No Records to update \_(&#12484;)_/</p></div>
            <div id="labor" class="hide">
                <div id="beginDates">
                    <!--Container to place all generated weeks-->
                    <div id="weeks"></div>
                </div>
            </div>
            <!--Clear and cancel options-->
            <div id="clearCancel" class="footer">
                <div id="mpwrComparison">
                    <div class="row">
                        <div class="col">Total Mpwr : <span class="col-2" id="hours"></span></div>
                    </div>
                </div>
                <div id="footerbuttons">
                    <button id="finishBtn" type="button" class="btn btn-success" title="Select Record First" disabled>Upload Schedule</button>
                    <button id="clearBtn" type="button" class="btn btn-secondary" title="Clear Manpower in each week">Clear Manpower</button>
                    <button id="resetBtn" type="button" class="btn btn-warning" title="Resets back to current state in QB">Reset</button>
                    <button id="exitBtn" type="button" class="btn btn-danger" title="Exit back to QB" value="exit">Exit</button>
                </div>
            </div>
        </div>
        <!--Modal Popup On Submission and Response-->
        <div id="loadScreen" class="modal fade" role="dialog" data-backdrop="static">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="modalTitle" class="modal-title"></h2>
                    </div>
                    <div class="modal-body">
                        <p id="modal-message"></p>
                    </div>
                    <div class="modal-footer">
                        <button id="closeModal" type="button" class="btn btn-secondary hide" data-dismiss="modal">Continue</button>
                        <button id="refreshPageBtn" type="button" class="btn btn-primary hide">Refresh</button>
                        <button id="exitModal" type="button" class="btn btn-danger hide" data-dismiss="modal" value="exit">Exit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>