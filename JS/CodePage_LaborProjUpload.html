<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <style>
        body {
            background-color: dimgray !important;
        }

        div {
            padding: 10px;
        }

        .MainContent {
            max-width: 400px;
            margin: auto;
            padding: 10px;
            background-color: white;
        }

        /*=========== Element Styles ===========*/
        /*Classes*/
        .header {
            background-color: black;
            color: white;
        }

        .hide {
            display: none !important;
        }

        .highMpwr::after {
            content: "Seems High";
            color: red;
        }

        .invalidEnd::after {
            content: "*End Date must be after Start Date";
            color: red;
        }

        .invalidStart::after {
            content: "*Start Date must be before Today";
            color: red;
        }

        .invalidDay::after {
            content: "*Must be a Monday";
            color: red;
        }

        .logo {
            text-align: center;
            color: rgb(227, 112, 39);
            font-weight: bold;
            font-style: italic;
            font-size: 28pt;
        }

        .negMpwr {
            color: red;
            font-weight: bold;
        }

        .posMpwr {
            color: green;
            font-weight: bold;
        }

        .show {
            display: block !important;
        }

        .spaced {
            white-space: pre-line;
        }

        .warning {
            color: red;
        }

        /*ID's*/
        #mpwrMismatch {
            color: red;
        }

        #noSplit {
            color: red;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/luxon@1.24.1/build/global/luxon.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
          integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z"
          crossorigin="anonymous">


    <meta charset="utf-8" />
    <title>Labor Projections Upload</title>
    <script>
        //Luxon Global Object
        let DateTime = luxon.DateTime;

        //===== Obtain Temp Key
        function getTempAuth(dbid, callback) {
            var headers = {
                'QB-Realm-Hostname': 'domain.quickbase.com',
                'QB-App-Token': '',
                'Content-Type': 'application/json'
            }

            const xmlHttp = new XMLHttpRequest();
            xmlHttp.open('GET', 'https://api.quickbase.com/v1/auth/temporary/' + dbid, true);
            for (const key in headers) {
                xmlHttp.setRequestHeader(key, headers[key]);
            }
            xmlHttp.onreadystatechange = function () {
                if (xmlHttp.readyState === XMLHttpRequest.DONE) {
                    typeof (callback) === "function" ? callback(xmlHttp.responseText) : alert("Callback not a function. Inform Brandon Drake \n(ext. 266)");
                }
            };
            xmlHttp.withCredentials = true
            //xmlHttp.send();
        }

        //===== Quick Base API to add records
        function AddRecords(records, recordID, dbid) {
            console.log(JSON.stringify(records));
            dbid?getTempAuth(dbid, function (response) {
                var parse = JSON.parse(response);
                var token = parse.temporaryAuthorization;

                $("#loadScreen").modal("toggle");
                var headers = {
                    'QB-Realm-Hostname': 'domain.quickbase.com',
                    'Authorization': 'QB-TEMP-TOKEN ' + token,
                    'Content-Type': 'application/json'
                }

                var body = {
                    "to": dbid, "data":
                        records
                };

                const xmlHttp = new XMLHttpRequest();
                xmlHttp.open('POST', 'https://api.quickbase.com/v1/records', true);
                for (const key in headers) {
                    xmlHttp.setRequestHeader(key, headers[key]);
                }
                xmlHttp.onreadystatechange = function () {
                    if (xmlHttp.readyState === XMLHttpRequest.DONE) {
                        let status = xmlHttp.status;
                        if (status === 0 || (status >= 200 && status < 400)) {
                            modalUpdate(status, "Success", recordID); //Update status to user
                        } else { modalUpdate(status, xmlHttp.responseText, recordID) }
                    }
                };
                //xmlHttp.send(JSON.stringify(body));
            }):alert("Error finding table. Please contact Brandon Drake \n(ext. 266)");
        }

        //===== Disply Opp Info
        function displayOppInfo() {
            let hash = window.location.hash.substr(1);
            let oppName = hash.split("_")[2];
            let oppDesc = hash.split("_")[3];
            let oppConstStart = hash.split("_")[1];

            //Set Opp Information
            if (oppConstStart) { $("#date_beginning").val(oppConstStart) };
            $("#oppName").text(decodeURIComponent(oppName));
            $("#oppDesc").text(decodeURIComponent(oppDesc));
        }

        //===== Generate the weeks and manpower
        function genWeeksBegin() {
            //Select and Format Begin/End Dates
            let startDate = DateTime.fromISO(document.getElementById("date_beginning").value);
            let endDate = DateTime.fromISO(document.getElementById("date_ending").value);
            let weekCounter = 0;

            if (checkDates(startDate, endDate)) {
                while (startDate <= endDate) {
                    //Date Attributes
                    let dateDisplay = document.createElement("label");
                        dateDisplay.id = "D" + weekCounter;
                        dateDisplay.innerHTML = startDate.toLocaleString();
                        dateDisplay.setAttribute("name", startDate.toISODate());
                        dateDisplay.setAttribute("for", "M" + weekCounter);
                    //Manpower Element Attributes
                    let manpwrInput = document.createElement("input");
                        manpwrInput.setAttribute("class", "form-control");
                        manpwrInput.type = "number";
                        manpwrInput.id = "M" + weekCounter;
                        manpwrInput.setAttribute("onchange", "checkEntry(this.value, this.id)");
                    let highMpwr = document.createElement("span");
                        highMpwr.className = "highMpwr hide warning";
                    // Place Elements
                    let divNode = document.createElement("div");
                        divNode.setAttribute("class", "week");
                        divNode.id = "W" + weekCounter;
                        divNode.appendChild(dateDisplay);
                        divNode.appendChild(manpwrInput);
                        divNode.appendChild(highMpwr);

                    //Add to weeks
                    document.getElementById("weeks").appendChild(divNode);

                    //Increment values
                    startDate = startDate.plus({ days: 7 });
                    weekCounter++;
                }


                //Auto set manpower fields if split checkbox is checked
                if ($("#evenSplit").is(":checked")) { setEqualMpwr(weekCounter) };

                //Display Results
                $("#labor").attr("class", "show");
                $("#addWeeks").attr("class", "hide");

                //Get new totals (if any)
                getMpwrTotal();
            };
        }

        /*===== Check for valid dates
            Return: Bool
        */
        function checkDates(startDate, endDate) {
            var today = new Date();
            let startDay = startDate.toLocaleString({ weekday: 'long' });
            let endDay = endDate.toLocaleString({ weekday: 'long' });
            let startIsMonday = startDay === "Monday";
            let endIsMonday = endDay === "Monday";
            let invalidStart = startDate < today;
            let invalidEnd = startDate > endDate;

            // Start check
            if (invalidStart && startIsMonday) {
                $("#start p.invalidStart").length ? "" : $("#start").append("<p class=invalidStart></p>");
            } else {
                $("#start p.invalidStart").remove() }

            // End check
            if (invalidEnd && endIsMonday) {
                $("#end p.invalidEnd").length ? "" : $("#end").append("<p class=invalidEnd></p>");
            } else { $("#end p.invalidEnd").remove() }

            //Start not a Monday
            if (!startIsMonday) {
                $("#start p.invalidDay").length ? "" : $("#start").append("<p class=invalidDay></p>");
            } else { $("#start p.invalidDay").remove() }

            //End not a Monday
            if (!endIsMonday) {
                $("#end p.invalidDay").length ? "" : $("#end").append("<p class=invalidDay></p>");
            } else { $("#end p.invalidDay").remove() }


            return (invalidStart || invalidEnd || !startIsMonday || !endIsMonday)
                ? false //Dates not correct
                : true //All dates valid tp proceed
        }

        //===== calc, split, set manpower evenly
        function setEqualMpwr(totalWeeks) {
            let totalMpwr = Math.round($("#totalMpwr").val());
            let weeklyMpwr = Math.floor(totalMpwr / totalWeeks);
            let remainder = totalMpwr % totalWeeks;

            if (totalMpwr >= totalWeeks) {
                for (var i = 0; i < totalWeeks; i++) {
                    var week = $("#M" + i);
                    //week.attr("readonly", true);
                    //distribute remainder to keep manpower relatively equal
                    if (remainder > 0) {
                        week.val(weeklyMpwr + 1);
                        remainder--;
                    } else { week.val(weeklyMpwr); }
                }
            } else {
                $("#noSplit").addClass("show").removeClass("hide");
                setTimeout(function () { $("#noSplit").addClass("hide").removeClass("show"); }, 5000);
                $("#evenSplit").prop("checked", false);
            }
        }

        //===== Generates the body of API Call
        function genUpsert() {
            let recordID = window.location.hash.substr(1).split("_")[0];
            let re = new RegExp(/\d{4}-\w{2}-\d+/);
            let isOpp = re.test(recordID);
            let records = [];
            let keyField = isOpp?"7":"";
            let dbid = "dbid";

            $(".week").each(function (index) {
                let date = $("#D" + index).attr("name");
                let mpwr = Math.round($("#M" + index).val());
                let record = {};

                record["12"] = { value: date };
                record["6"] = { value: mpwr };
                record[keyField] = { value: recordID };
                records.push(record);
            })

            if (!getMpwrTotal()) {
                window.scrollTo(0, 0);
                $("#mpwrMismatch").addClass("show").removeClass("hide");
            } else { AddRecords(records, recordID, dbid) };
        }

        //===== Check Mpwr Entry for large values
        function checkEntry(value, id) {
            parseInt(value) < 30
                ?$("#" + id).siblings(".highMpwr").removeClass("show").addClass("hide")
                :$("#" + id).siblings(".highMpwr").removeClass("hide").addClass("show").val("Seems High");

            getMpwrTotal();
        }

        /*===== Total Manpower
            Return: Bool
        */
        function getMpwrTotal() {
            let mpwrNeeded = Math.round($("#totalMpwr").val());
            let totalMpwr = 0;
            let mpwrRemain = 0;
            let mpwrJQ = $("#hours");
            let remainJQ = $("#hoursRemaining");

            $(".week" ).each(function (index) {
                let mpwr = Math.round($("#M" + index).val());
                totalMpwr += mpwr;
            });


            //Set New Values
            mpwrRemain = mpwrNeeded > 0 ? totalMpwr - mpwrNeeded:0;
            mpwrJQ.text(totalMpwr);
            mpwrRemain === 0
                ? remainJQ.attr("class", "posMpwr").text("Hours Match: " + mpwrRemain)
                : remainJQ.attr("class", "negMpwr").text("Hours Difference: " + mpwrRemain);

            //UI Clean-up
            if ($("#mpwrMismatch").hasClass("show")) { $("#mpwrMismatch").addClass("hide").removeClass("show") };

            return mpwrRemain === 0 || mpwrNeeded <= 0;
        }

        //===== Updates Labor Weeks with new data
        function updateWeeks() {
            $(".week").remove();
            genWeeksBegin();
            $("#updateWeeks").attr("class", "hide");
        }

        //===== Display Update Weeks Button if any field changes
        function showUpdate() {
            $("#labor").attr("class", "hide");
            $("#addWeeks").hasClass("hide") ? $("#updateWeeks").attr("class", "show") : "";
        }

        //===== Clear All Data
        function clearWeeks() {
            $(".week").remove();
            $("#date_beginning").val("");
            $("#date_ending").val("");
            $("#totalMpwr").val("");
            $("#evenSplit").prop("checked", false);
            $("#labor").attr("class", "hide");
            $("#addWeeks").attr("class", "show");
        }

        //===== Updates the Modal Window to inform User of status
        function modalUpdate(status, requestMessage, recordID) {
            let message = $("#modal-message");

            if (typeof failCounter == 'undefined') {
                failCounter = 0;
            }
            if (status >= 200 && status < 400) {
                message.text("Loaded Sucessfully. Navigating to Opportunity");
                setTimeout(3000, window.location = "/db/bpmpd3j7p?a=dr&key=" + recordID); //redirect to opportunity in QB
            } else if (failCounter === 0) {
                message.text("Loading Failed. Click outside this box to update or retry");
                failCounter++;
            } else {
                message.text(requestMessage + "\nPlease take a screen shot or contact Brandon Drake \n(ext. 266)");
                message.addClass("spaced");
                $("#closeModal").removeClass("hide");
            }
        }

        //===== Navigate back when cancelled
        function goBack() {
            window.history.go(-1);
        }

    </script>
</head>

<body onload="displayOppInfo()">
    <div class="MainContent">
        <!--Modal Popup On Submission and Response-->
        <div id="loadScreen" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Uploading Labor Projections</h2>
                    </div>
                    <div class="modal-body">
                        <p id="modal-message">Loading.... Please wait.</p>
                    </div>
                    <div class="modal-footer">
                        <button id="closeModal" type="button" onclick="goBack()" class="btn btn-danger hide" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <!--Opp Information and Header-->
        <div class="header">
            <div class="logo">
                <span>Janotta &amp; Herner</span>
            </div>
            <div>
                <span><strong>Labor Projections For:</strong></span> <br />
                <span id="oppName"></span> <br />
                <span id="oppDesc"></span>
            </div>
        </div>
        <!--Begin User Input and Control-->
        <div id="start">
            <label for="date_beginning">Date Beginning</label>
            <input class="form-control col-md-8" onchange="showUpdate()" type="date" id="date_beginning" value="2020-10-05" /><!--value="2020-10-05"-->
        </div>
        <div id="end">
            <label for="date_ending">Date Ending</label>
            <input type="date" class="form-control col-md-8" onchange="showUpdate()" id="date_ending" value="2020-10-26" /><!--value="2020-10-26"-->
        </div>
        <div id="mpwr">
            <label for="totalMpwr">Total Manpower Needed</label>
            <input type="number" class="form-control col-md-8" id="totalMpwr" onchange="getMpwrTotal()" value="12" /><!--value="12"-->
        </div>
        <div id="genDatesButton" class="show">
            <input type="checkbox" onchange="showUpdate()" id="evenSplit" />
            <label for="evenSplit">Split Evenly</label>
            <p> <span id="noSplit" class="warning hide">Cannot Split - Manpower < Total Weeks: <br /> Enter Manually</span> </p>
            <span id="addWeeks" class="show">
                <button type="button" class="btn btn-primary" onclick="genWeeksBegin()">Generate Labor Schedule</button>
            </span>
            <span id="updateWeeks" class="hide">
                <button type="button" class="btn btn-warning" onclick="updateWeeks()">Update Labor Schedule</button>
            </span>
        </div>
        <hr />
        <!--Manpower Totals and Comparison Info-->
        <div id="labor" class="hide">
            <div id="mpwrComparison">
                <h3>Week Begin</h3>
                <div>Total Hours: <span id="hours"></span></div>
                <div><span id="hoursRemaining"></span></div>
                <div id="mpwrMismatch" class="warning hide"><span>Manpower totals do not match</span></div>
            </div>
            <div id="beginDates">
                <!--Container to place all generated weeks-->
                <div class="form-group col-md-8" id="weeks">
                </div>
                <div>
                    <button id="finishBtn" type="button" class="btn btn-success" onclick="genUpsert()">Upload Schedule</button>
                </div>
            </div>
        </div>
        <!--Clear and cancel options-->
        <div id="clearCancel">
            <button id="clearBtn" type="button" class="btn btn-warning" onclick="clearWeeks()">Clear</button>
            <button id="cancelBtn" type="button" class="btn btn-danger" onclick="goBack()">Cancel</button>
        </div>
    </div>
</body>
</html>